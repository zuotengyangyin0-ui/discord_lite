<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Discord Lite</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class'
            }
        </script>
<style>
    :root {
        --bg-primary: #f5f5f5;
        --bg-secondary: #ffffff;
        --bg-tertiary: #e0e0e0;
        --bg-quaternary: #ebebeb;
        --text-primary: #111111;
        --text-secondary: #555555;
        --text-link: #4f89e2;
        --border-color: #cccccc;
        --button-bg: #5865f2;
        --button-text: #fff;
        --hover-bg: #f0f0f0;
        --active-bg: #e0e0e0;
        --mention-bg: rgba(88, 101, 242, 0.1);
        --mention-fg: #5865f2;
        --system-bg: rgba(88, 166, 255, 0.1);
        --status-online: #3ba55d;
        --status-idle: #faa81a;
        --status-dnd: #ed4245;
        --status-offline: #747f8d;
    }

    html.dark {
        --bg-primary: #36393f;
        --bg-secondary: #2f3136;
        --bg-tertiary: #202225;
        --bg-quaternary: #292b2f;
        --text-primary: #e0e0e0;
        --text-secondary: #b9bbbe;
        --text-link: #58a6ff;
        --border-color: #40444b;
        --button-bg: #5865f2;
        --button-text: #ffffff;
        --hover-bg: #3a3c41;
        --active-bg: #40444b;
        --mention-bg: rgba(88, 101, 242, 0.15);
        --mention-fg: #7289da;
        --system-bg: rgba(88, 166, 255, 0.1);
    }

    html.dark .input-field {
        color: var(--text-primary);
    }

    .server-icon, .channel-item {
        position: relative;
    }

    .server-icon {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
    }
    
    .server-icon.active img, .server-icon.active div {
        border-radius: 0.5rem;
        transition: border-radius 0.5s ease-in-out;
    }


    .ping-dot {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 10px;
        height: 10px;
        background-color: #f84a4b;
        border-radius: 50%;
        border: 2px solid var(--bg-tertiary);
        z-index: 10;
    }

    .channel-item .ping-dot {
        bottom: 10px;
        right: 10px;
    }

    .channel-item.active {
        background-color: var(--active-bg);
    }

    .loader {
        border: 4px solid var(--bg-tertiary);
        border-top: 4px solid var(--button-bg);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--bg-tertiary);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .mention {
        color: var(--mention-fg);
        background-color: var(--mention-bg);
        padding: 0 2px;
        border-radius: 3px;
        font-weight: 500;
        cursor: pointer;
    }

    .message-group:hover .message-toolbar {
        visibility: visible;
        opacity: 1;
    }

    .message-toolbar {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.1s ease-in-out;
    }

    .status-dot {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 3px solid var(--bg-secondary);
        z-index: 5;
    }

    .status-dot.online { background-color: var(--status-online); }
    .status-dot.idle { background-color: var(--status-idle); }
    .status-dot.dnd { background-color: var(--status-dnd); }
    .status-dot.offline { background-color: var(--status-offline); }
</style>
    </head>
    <body class="font-sans h-screen flex flex-col overflow-hidden bg-gray-200 dark:bg-gray-800 text-[var(--text-primary)]">
        <div id="auth-section" class="w-full max-w-md m-auto p-8 rounded-lg shadow-xl flex-col bg-white dark:bg-gray-700 hidden">
            <h1 class="text-2xl font-bold text-center mb-2">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</h1>
            <div id="login-error" class="text-red-500 text-xs mb-3 text-center"></div>
            <form class="space-y-4" onsubmit="return false;">
                <input type="password" id="token-input" class="input-field w-full p-2.5 rounded-md" placeholder="Discord Token">
                <button type="button" id="add-account-button" class="bg-blue-600 hover:bg-blue-700 w-full py-3 rounded-md font-bold text-white flex justify-center items-center">
                    <span id="add-account-button-text">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</span>
                    <div id="login-spinner" class="loader hidden"></div>
                </button>
                <button type="button" id="cancel-add-account-button" class="bg-gray-600 hover:bg-gray-700 w-full py-2 rounded-md font-bold text-white">„Ç≠„É£„É≥„Çª„É´</button>
            </form>
        </div>
        <div id="main-app" class="hidden flex-1 flex-row min-h-0 relative">
            <div id="sidebar-view" class="flex flex-row w-full h-full md:w-auto md:flex">
                <div class="p-2 flex flex-col items-center gap-2 overflow-y-auto flex-shrink-0" style="background-color: var(--bg-tertiary);">
                    <div id="dm-icon" title="DM" class="server-icon bg-indigo-600 flex items-center justify-center cursor-pointer text-white font-black text-xl mb-1">DM</div>
                    <div id="guild-list" class="flex flex-col items-center gap-2 w-full"></div>
                    <div class="mt-auto flex flex-col gap-2 pt-4">
                        <button id="theme-toggle-btn" class="server-icon bg-gray-500 hover:bg-gray-600 flex items-center justify-center text-white" title="„ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà"></button>
                        <a href="https://github.com/Bloxd-H/discord_lite" target="_blank" class="server-icon bg-gray-700 hover:bg-gray-800 text-white flex items-center justify-center" title="GitHub">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0C5.373 0 0 5.373 0 12c0 5.303 3.438 9.8 8.207 11.387.599.11.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.91 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.303 24 12 24 5.373 18.627 0 12 0z"/>
                            </svg>
                        </a>
                    </div>
                </div>
                <div class="w-full md:w-64 flex flex-col border-r flex-1 min-h-0" style="border-color: var(--border-color); background-color: var(--bg-secondary);">
                    <div class="p-4 border-b font-bold truncate flex-shrink-0" id="guild-name" style="border-color: var(--border-color);"></div>
                    <div id="channel-list" class="flex-1 overflow-y-auto p-2"></div>
                    <div class="relative flex-shrink-0">
                        <div id="user-info-panel" class="p-2 border-t flex items-center gap-3 cursor-pointer hover:bg-gray-500/10" style="border-color: var(--border-color);"></div>
                        <div id="account-switcher" class="hidden absolute bottom-full left-0 w-full p-2 mb-2 rounded-lg shadow-2xl" style="background-color: var(--bg-tertiary);">
                            <div id="account-list" class="flex flex-col gap-1"></div>
                            <div id="add-account-switcher-btn" class="mt-2 text-center text-sm p-2 rounded-md cursor-pointer hover:bg-gray-500/20">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="chat-section" class="hidden flex-1 md:flex flex-col min-h-0 min-w-0">
                <div class="p-3 border-b flex items-center justify-between flex-shrink-0" style="border-color: var(--border-color); background-color:var(--bg-secondary);">
                    <div class="font-bold flex items-center truncate">
                        <button id="back-to-channels-btn" class="mr-3 p-1 rounded-full hover:bg-gray-500/20 md:hidden">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <span id="channel-name-text"></span>
                    </div>
                </div>
                <div id="message-container" class="flex-1 overflow-y-auto p-4 space-y-1" style="background-color: var(--bg-primary);"></div>
                <div class="flex-shrink-0">
                    <div id="slash-command-picker" class="hidden p-2 border-t" style="border-color:var(--border-color); background-color: var(--bg-quaternary);">
                        <b>Âà©Áî®ÂèØËÉΩ„Å™„Ç≥„Éû„É≥„Éâ:</b>
                        <div class="text-xs opacity-70">„Ç≥„Éû„É≥„ÉâÊ©üËÉΩ„ÅØÁèæÂú®ÈñãÁô∫‰∏≠„Åß„Åô„ÄÇ</div>
                    </div>
                    <div id="attachment-preview-bar" class="hidden p-2 text-sm border-t items-center justify-between" style="border-color: var(--border-color); background-color: var(--bg-quaternary);">
                        <div>
                            Attaching: <b id="attachment-preview-name"></b>
                        </div>
                        <button id="cancel-attachment-btn" class="p-1 rounded-full hover:bg-gray-500/30">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-4 border-t flex items-end gap-2" style="border-color: var(--border-color); background-color:var(--bg-secondary);">
                        <input type="file" id="file-input" class="hidden" multiple>
                        <button id="attach-button" class="p-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 flex-shrink-0" title="„Éï„Ç°„Ç§„É´„ÇíÊ∑ª‰ªò">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v11.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"></path>
                            </svg>
                        </button>
                        <div class="relative w-full">
                            <div id="reply-bar" class="hidden absolute bottom-full left-0 w-full text-sm p-2 bg-[var(--bg-quaternary)] rounded-t-md">
                                Replying to <b id="reply-username"></b>
                                <button id="cancel-reply-btn" class="absolute right-2 top-2 p-1 rounded-full hover:bg-gray-500/30">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                            <textarea id="message-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°" class="input-field w-full p-3 rounded-md resize-none pr-16" rows="1"></textarea>
                            <div id="char-counter" class="absolute bottom-2 right-2 text-xs text-gray-500"></div>
                        </div>
                        <button id="send-button" class="p-3 rounded-md font-bold text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50" disabled>
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                <div class="bg-[var(--bg-secondary)] dark:bg-gray-700 rounded-lg shadow-2xl w-full max-w-sm" style="border-color: var(--border-color);">
                    <div id="profile-modal-header" class="h-20 rounded-t-lg relative" style="background-color: var(--button-bg);">
                        <button onclick="closeProfileModal()" class="absolute top-2 right-2 p-1 rounded-full text-white hover:bg-black/20">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div class="p-4 pt-0">
                        <div class="flex relative -mt-12 mb-4">
                            <img id="profile-avatar" class="w-24 h-24 rounded-full border-4" style="border-color: var(--bg-secondary);">
                            <div id="profile-status-dot" class="status-dot w-5 h-5" style="bottom: 4px; right: 4px; border-width: 4px;"></div>
                        </div>
                        <h2 id="profile-name" class="text-xl font-bold truncate"></h2>
                        <div id="profile-username" class="text-sm opacity-60 mb-4"></div>
                        <div id="profile-details">
                            <div class="mb-3">
                                <b class="block text-xs uppercase opacity-70">„É°„É≥„Éê„Éº„Ç∑„ÉÉ„Éó</b>
                                <span id="profile-member-since" class="text-sm"></span>
                            </div>
                        </div>
                        <button id="block-user-btn" class="w-full bg-red-600 hover:bg-red-700 py-2 mt-4 rounded-md font-bold text-white"></button>
                    </div>
                </div>
            </div>

            <div id="status-picker" class="hidden absolute bottom-20 left-2 w-48 p-2 rounded-lg shadow-2xl z-20" style="background-color: var(--bg-tertiary);">
                <div class="text-xs font-bold uppercase opacity-70 mb-1">„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíË®≠ÂÆö</div>
                <div id="status-online" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('online')">
                    <div class="status-dot online"></div><span class="ml-4">„Ç™„É≥„É©„Ç§„É≥</span>
                </div>
                <div id="status-idle" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('idle')">
                    <div class="status-dot idle"></div><span class="ml-4">ÈÄÄÂ∏≠‰∏≠</span>
                </div>
                <div id="status-dnd" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('dnd')">
                    <div class="status-dot dnd"></div><span class="ml-4">Âèñ„ÇäËæº„Åø‰∏≠</span>
                </div>
                <div id="status-offline" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('invisible')">
                    <div class="status-dot offline"></div><span class="ml-4">„Ç™„Éï„É©„Ç§„É≥</span>
                </div>
            </div>
        </div>
<script>
const BASE_URL = 'https://yakisoba.cloudfree.jp/avoidcord';
const API_BASE = `${BASE_URL}`;
const CDN_BASE = BASE_URL;

let currentAccount = null;
let currentChannel = null;
let replyingTo = null;
let oldestMessageId = null;
let isLoadingMore = false;
let attachedFiles = [];
let maxCharCount = 2000;
let guildFolders = [];
let guildDataMap = new Map();
let openFolderId = null;
let pingCounts = {};
let messageStore = {};
let editedMessages = {};
let dragCounter = 0;
let pendingFiles = [];

let pollingInterval = null;

const plugins = JSON.parse(localStorage.getItem('plugins')) || {
    showMeYourName: false,
    sendSeconds: false,
    messageLogger: true,
    clickAction: true,
    showCharacter: true
};

document.addEventListener('DOMContentLoaded', async () => {
    if (localStorage.theme === 'dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    }
    
    document.body.addEventListener('paste', e => {
        const files = e.clipboardData.files;
        if (files.length > 0) {
            e.preventDefault();
            handleFiles(files);
        }
    });
    
    const dragOverlay = document.getElementById('drag-overlay');
    document.addEventListener('dragenter', (e) => {
        e.preventDefault();
        dragCounter++;
        document.body.classList.add('dragging');
    });
    document.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dragCounter--;
        if(dragCounter === 0) document.body.classList.remove('dragging');
    });
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', (e) => {
        e.preventDefault();
        dragCounter = 0;
        document.body.classList.remove('dragging');
        if (e.dataTransfer.files.length > 0) {
            handleFiles(e.dataTransfer.files);
        }
    });

    document.getElementById('dm-icon').onclick = loadDms;
    document.getElementById('send-button').onclick = sendMessage;
    
    document.getElementById('attach-button').onclick = () => {
        document.getElementById('file-input').click();
    };

    document.getElementById('file-input').onchange = (e) => {
        if (e.target.files.length) handleFiles(e.target.files);
    };

    document.getElementById('cancel-reply-btn').onclick = cancelReply;
    
    const input = document.getElementById('message-input');
    input.oninput = handleInput;
    input.onkeypress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    };
    input.onkeydown = (e) => {
        if(e.key === 'ArrowUp' && input.value === '') {
            e.preventDefault();
            const els = Array.from(document.querySelectorAll('.message-group')).reverse();
            for(let el of els) {
                if(el.dataset.authorId === currentAccount.id && !el.classList.contains('message-failed')) {
                    startEdit(el.id.replace('message-', ''));
                    break;
                }
            }
        }
    }

    document.getElementById('back-to-channels-btn').onclick = showSidebarView;
    document.getElementById('open-settings-btn').onclick = (e) => {
        e.stopPropagation();
        renderSettingsModal();
    };
    
    document.getElementById('add-account-switcher-btn').onclick = () => {
        document.getElementById('account-switcher').classList.add('hidden');
        showLoginScreen();
    };

    window.addEventListener('resize', handleResize);

    const accounts = getAccounts();
    const activeId = getActiveAccountId();
    
    if (accounts.length > 0 && activeId) {
        switchAccount(activeId);
    } else {
        showLoginScreen();
    }
});

function handleFiles(files) {
    if(attachedFiles.length >= 10) return alert('„Éï„Ç°„Ç§„É´„ÅØ10ÂÄã„Åæ„Åß„Åß„Åô');
    for (const f of files) {
        if(attachedFiles.length < 10) attachedFiles.push(f);
    }
    renderAttachmentList();
    handleInput();
}

function renderAttachmentList() {
    const list = document.getElementById('attachment-list');
    list.innerHTML = '';
    if (attachedFiles.length === 0) {
        list.classList.add('hidden');
        return;
    }
    list.classList.remove('hidden');
    attachedFiles.forEach((f, idx) => {
        const el = document.createElement('div');
        el.className = "bg-[var(--bg-tertiary)] rounded px-2 py-1 text-xs flex items-center gap-2 border border-[var(--border-color)]";
        el.innerHTML = `<span class="truncate max-w-[150px]">${f.name}</span> <button class="text-red-500 font-bold hover:text-red-700">√ó</button>`;
        el.querySelector('button').onclick = () => {
            attachedFiles.splice(idx, 1);
            renderAttachmentList();
            handleInput();
        };
        list.appendChild(el);
    });
}

const getAccounts = () => JSON.parse(localStorage.getItem('accounts')) || [];
const saveAccounts = a => localStorage.setItem('accounts', JSON.stringify(a));
const getActiveAccountId = () => localStorage.getItem('activeAccountId');
const setActiveAccountId = id => localStorage.setItem('activeAccountId', id);

async function apiRequest(token, path, method = 'GET', body = null, isFormData = false) {
    const opts = { 
        method, 
        headers: { 
            'Authorization': token, 
            'X-Super-Properties': btoa(JSON.stringify({os:"Windows",browser:"Chrome",device:"",system_locale:"ja",client_build_number:262355})) 
        } 
    };
    if (body) {
        if (isFormData) {
            opts.body = body;
        } else {
            opts.body = JSON.stringify(body);
            opts.headers['Content-Type'] = 'application/json';
        }
    }
    try {
        const r = await fetch(`${API_BASE}${path}`, opts);
        if (r.status === 401) return { error: { message: "Unauthorized" }, status: 401 };
        const data = r.status === 204 ? {} : await r.json();
        if (!r.ok) return { error: data, status: r.status };
        return { data, status: r.status };
    } catch (e) {
        return { error: { message: "Network error" }, status: 0 };
    }
}

function cleanupState() {
    if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
    currentChannel = null;
    attachedFiles = [];
    document.getElementById('guild-list').innerHTML = '';
    document.getElementById('channel-list').innerHTML = '';
    document.getElementById('message-container').innerHTML = '';
    document.getElementById('guild-name').innerText = '';
    
    messageStore = {}; 
    guildFolders = []; 
    guildDataMap.clear();
    editedMessages = {};
    pingCounts = {};
    
    cancelReply();
    renderAttachmentList();
}

function switchAccount(id) {
    cleanupState();
    setActiveAccountId(id);
    const accounts = getAccounts();
    const account = accounts.find(a => a.id === id);
    if (!account) { showLoginScreen(); return; }
    currentAccount = account;
    maxCharCount = (currentAccount.premium_type === 2) ? 4000 : 2000;
    document.getElementById('token-input').value = '';
    updateView('app');
    renderCurrentUserPanel();
    loadGuilds();
}

function updateView(viewName) {
    const authSection = document.getElementById('auth-section');
    const mainApp = document.getElementById('main-app');
    if (viewName === 'auth') {
        authSection.classList.remove('hidden'); authSection.classList.add('flex');
        mainApp.classList.add('hidden'); mainApp.classList.remove('flex');
    } else if (viewName === 'app') {
        authSection.classList.add('hidden'); authSection.classList.remove('flex');
        mainApp.classList.remove('hidden'); mainApp.classList.add('flex');
        if (window.innerWidth < 768) showSidebarView();
    }
}

function showLoginScreen(reloginAccount = null) {
    cleanupState();
    updateView('auth');
    document.getElementById('migration-view').classList.add('hidden');
    document.getElementById('token-input-view').classList.add('hidden');
    renderSavedAccountsList();
    const accounts = getAccounts();
    if (accounts.length > 0 && !reloginAccount) {
        document.getElementById('account-selection-view').classList.remove('hidden');
        document.getElementById('account-selection-view').classList.add('flex');
    } else {
        showTokenInput(reloginAccount);
    }
}

function showTokenInput(account) {
    document.getElementById('account-selection-view').classList.add('hidden');
    document.getElementById('account-selection-view').classList.remove('flex');
    document.getElementById('token-input-view').classList.remove('hidden');
    document.getElementById('token-input-view').classList.add('flex');
    document.getElementById('token-input').value = '';
    
    const userInfo = document.getElementById('relogin-user-info');
    if (account) {
        document.getElementById('auth-title').innerText = 'ÂÜç„É≠„Ç∞„Ç§„É≥';
        userInfo.classList.remove('hidden'); 
        userInfo.classList.add('flex');
        document.getElementById('relogin-name').innerText = account.global_name || account.username;
        document.getElementById('relogin-username').innerText = account.username;
        const avatar = account.avatar ? `${CDN_BASE}/avatars/${account.id}/${account.avatar}.png?size=128` : `${CDN_BASE}/embed/avatars/${account.discriminator % 5}.png`;
        document.getElementById('relogin-avatar').src = avatar;
        
        document.getElementById('token-label').innerText = 'Êñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„É≥';
        document.getElementById('add-account-button-text').innerText = '„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞';
        document.getElementById('add-account-button').onclick = () => addAccount(document.getElementById('token-input').value, account.id);
    } else {
        document.getElementById('auth-title').innerText = '„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†';
        userInfo.classList.add('hidden'); 
        userInfo.classList.remove('flex');
        document.getElementById('token-label').innerText = '„Éà„Éº„ÇØ„É≥';
        document.getElementById('add-account-button-text').innerText = '„É≠„Ç∞„Ç§„É≥';
        document.getElementById('add-account-button').onclick = () => addAccount(document.getElementById('token-input').value);
    }
}

function handleResize() { 
    if (window.innerWidth >= 768) {
        showChatView();
        document.getElementById('sidebar-view').classList.remove('hidden');
    } else if (currentChannel) {
        showChatView();
    } else {
        showSidebarView(); 
    }
}
function showSidebarView() { 
    document.getElementById('sidebar-view').classList.remove('hidden'); 
    document.getElementById('chat-section').classList.add('hidden'); 
}
function showChatView() { 
    document.getElementById('sidebar-view').classList.add('hidden'); 
    document.getElementById('chat-section').classList.remove('hidden'); 
    document.getElementById('chat-section').classList.add('flex'); 
}

function renderSavedAccountsList() {
    const list = document.getElementById('saved-accounts-list');
    const accounts = getAccounts();
    list.innerHTML = '';
    accounts.forEach(acc => {
        const div = document.createElement('div');
        div.className = "flex items-center gap-3 p-3 border rounded hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition-colors";
        div.style.borderColor = 'var(--border-color)';
        const avatar = acc.avatar ? `${CDN_BASE}/avatars/${acc.id}/${acc.avatar}.png?size=64` : `${CDN_BASE}/embed/avatars/${acc.discriminator % 5}.png`;
        div.innerHTML = `<img src="${avatar}" class="w-10 h-10 rounded-full bg-gray-300"><div class="flex-1 min-w-0"><div class="font-bold truncate">${acc.global_name || acc.username}</div><div class="text-xs text-[var(--text-secondary)] truncate">@${acc.username}</div></div><div class="delete-btn p-2 text-gray-400 hover:text-red-500 rounded-full" title="ÂâäÈô§"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></div>`;
        div.onclick = (e) => { 
            if (e.target.closest('.delete-btn')) return; 
            switchAccount(acc.id); 
        };
        div.querySelector('.delete-btn').onclick = (e) => deleteAccount(acc.id, e);
        list.appendChild(div);
    });
}

function renderCurrentUserPanel() {
    if (!currentAccount) return;
    const nameEl = document.getElementById('current-user-name');
    const subEl = document.getElementById('current-user-subtext');
    const avCont = document.getElementById('current-user-avatar-container');
    
    nameEl.textContent = currentAccount.global_name || currentAccount.username;
    subEl.textContent = `@${currentAccount.username}`;
    
    const avatar = currentAccount.avatar ? `${CDN_BASE}/avatars/${currentAccount.id}/${currentAccount.avatar}.png?size=64` : `${CDN_BASE}/embed/avatars/${currentAccount.discriminator % 5}.png`;
    let deco = '';
    if(currentAccount.avatar_decoration_data) {
        const decoUrl = `${CDN_BASE}/avatar-decoration-presets/${currentAccount.avatar_decoration_data.asset}.png?size=96`;
        deco = `<img src="${decoUrl}" class="avatar-decoration">`;
    }
    avCont.innerHTML = `<img src="${avatar}" class="avatar-img shadow-sm rounded-full">${deco}`;
    renderAccountSwitcher();
}

function renderAccountSwitcher() {
    const list = document.getElementById('account-list');
    const accounts = getAccounts();
    const activeId = getActiveAccountId();
    
    list.innerHTML = accounts.map(acc => {
        const av = acc.avatar ? `${CDN_BASE}/avatars/${acc.id}/${acc.avatar}.png?size=64` : `${CDN_BASE}/embed/avatars/${acc.discriminator % 5}.png`;
        const isActive = acc.id === activeId;
        return `<div class="flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-[var(--button-bg)] hover:text-white group" onclick="switchAccount('${acc.id}')">
            <img src="${av}" class="w-8 h-8 rounded-full">
            <span class="flex-1 truncate text-sm font-semibold">${acc.global_name || acc.username}</span> 
            ${isActive ? '<div class="w-2 h-2 rounded-full bg-green-500"></div>' : ''} 
            <div onclick="deleteAccount('${acc.id}',event)" title="ÂâäÈô§" class="hidden group-hover:block p-1 hover:bg-black/20 rounded-full">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </div>
        </div>`;
    }).join('');
}

function createServerIconElement(s, isInFolder = false) {
    let el = document.createElement('div'); 
    el.id = `guild-${s.id}`; 
    el.className = 'server-icon group ' + (isInFolder ? 'in-folder' : '');
    el.title = s.name;
    el.onclick = () => loadChannels(s, el);
    
    el.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        navigator.clipboard.writeText(s.id).then(() => alert('„Çµ„Éº„Éê„ÉºID„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü: ' + s.id));
    });
    
    if (s.icon) {
        el.innerHTML = `<img src="${CDN_BASE}/icons/${s.id}/${s.icon}.png?size=128" class="object-cover w-full h-full transition-all group-hover:rounded-2xl rounded-[50%]">`;
    } else {
        el.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-700 text-white font-bold text-sm transition-all group-hover:rounded-2xl rounded-[50%]">${s.name.substring(0, 2)}</div>`;
    }
    return el;
}

function renderFolders() {
    const list = document.getElementById('guild-list');
    list.innerHTML = '';
    
    guildFolders.forEach(item => {
        if (!item.guild_ids || item.guild_ids.length === 0) return;
        
        if (item.id) {
            const folderWrap = document.createElement('div');
            folderWrap.className = 'server-folder-wrapper flex flex-col items-center gap-2 w-full transition-all';
            folderWrap.id = `folder-${item.id}`;
            
            const containedGuilds = item.guild_ids.map(id => guildDataMap.get(id)).filter(Boolean);
            if (containedGuilds.length === 0) return;

            const header = document.createElement('div');
            header.className = 'folder-closed group'; 
            
            const createMiniGrid = () => {
                header.innerHTML = '';
                containedGuilds.slice(0, 4).forEach(g => {
                    const img = document.createElement('img');
                    img.className = 'folder-icon-thumb';
                    img.src = g.icon ? `${CDN_BASE}/icons/${g.id}/${g.icon}.png?size=64` : `${CDN_BASE}/embed/avatars/0.png`;
                    header.appendChild(img);
                });
            }
            createMiniGrid();

            let folderColor = 'rgba(88, 101, 242, 0.4)';
            if (item.color) {
                const r = (item.color >> 16) & 255; const g = (item.color >> 8) & 255; const b = item.color & 255;
                folderColor = `rgba(${r},${g},${b},0.4)`;
            }
            header.style.backgroundColor = folderColor;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'hidden flex-col gap-2 items-center w-full transition-all py-1';
            containedGuilds.forEach(g => contentDiv.appendChild(createServerIconElement(g, true)));

            header.onclick = () => {
                const isOpen = openFolderId === item.id;
                if (isOpen) {
                    openFolderId = null;
                    contentDiv.classList.add('hidden'); contentDiv.classList.remove('flex');
                    header.classList.remove('folder-opened'); header.classList.add('folder-closed');
                    header.style.backgroundColor = folderColor;
                    createMiniGrid();
                } else {
                    if (openFolderId) {
                        const prevOpen = document.querySelector(`#folder-${openFolderId} .folder-opened`);
                        if (prevOpen) prevOpen.click(); 
                    }
                    openFolderId = item.id;
                    contentDiv.classList.remove('hidden'); contentDiv.classList.add('flex');
                    header.classList.remove('folder-closed'); header.classList.add('folder-opened');
                    header.innerHTML = `<div class="text-white opacity-80 w-6 h-6"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 7H12L10 5H4C2.9 5 2.01 5.9 2.01 7L2 19C2 20.1 2.9 21 4 21H20C21.1 21 22 20.1 22 19V9C22 7.9 21.1 7 20 7Z"/></svg></div>`;
                    header.style.backgroundColor = 'rgba(88, 101, 242, 0.3)';
                }
            };
            folderWrap.appendChild(header); 
            folderWrap.appendChild(contentDiv);
            list.appendChild(folderWrap);
        } else {
            item.guild_ids.forEach(gid => {
                const s = guildDataMap.get(gid);
                if (s) list.appendChild(createServerIconElement(s));
            });
        }
    });
}

async function loadGuilds() {
    if (!currentAccount) return;
    const res = await apiRequest(currentAccount.token, '/users/@me/guilds');
    if (res.error) {
        if (res.status === 401) showLoginScreen(currentAccount);
        return;
    }
    guildDataMap.clear();
    res.data.forEach(s => guildDataMap.set(s.id, s));
    
    if (guildFolders.length > 0) { renderFolders(); } else {
        const list = document.getElementById('guild-list');
        list.innerHTML = '';
        res.data.forEach(s => list.appendChild(createServerIconElement(s)));
    }
}

async function loadDms() {
    if (!currentAccount) return;
    
    document.querySelectorAll('.server-icon.active').forEach(e => e.classList.remove('active'));
    document.getElementById('dm-icon').classList.add('active');
    document.getElementById('guild-name').innerText = 'Direct Messages';
    
    const res = await apiRequest(currentAccount.token, '/users/@me/channels');
    if (res.error) return;
    
    const list = document.getElementById('channel-list');
    list.innerHTML = '';
    const dms = res.data.sort((a,b) => (b.last_message_id||0) - (a.last_message_id||0));
    
    dms.forEach(dm => {
        const div = document.createElement('div');
        div.className = "channel-item p-1.5 pl-3 rounded-md cursor-pointer mb-0.5 text-[0.95em] truncate flex items-center";
        
        let icon = '<span class="text-xl mr-2 text-[var(--text-secondary)]">@</span>';
        let name = "DM";
        if(dm.recipients && dm.recipients[0]) {
            const user = dm.recipients[0];
            const av = user.avatar ? `${CDN_BASE}/avatars/${user.id}/${user.avatar}.png?size=32` : `${CDN_BASE}/embed/avatars/0.png`;
            icon = `<img src="${av}" class="w-5 h-5 mr-2 rounded-full">`;
            name = user.global_name || user.username;
        }
        
        div.innerHTML = `${icon}<span>${name}</span>`;
        div.onclick = () => selectChannel(dm);
        list.appendChild(div);
    });
    updatePingDots();
}

async function loadChannels(g, element) {
    if (!currentAccount) return;
    document.querySelectorAll('.server-icon.active').forEach(e => e.classList.remove('active'));
    if (element) element.classList.add('active');
    
    document.getElementById('guild-name').innerText = g.name;
    const res = await apiRequest(currentAccount.token, `/guilds/${g.id}/channels`);
    if (res.error) return;
    
    const list = document.getElementById('channel-list');
    list.innerHTML = '';
    const channels = res.data;
    const grouped = channels.reduce((acc, ch) => { 
        (acc[ch.parent_id || 'null'] = acc[ch.parent_id || 'null'] || []).push(ch); 
        return acc; 
    }, {});
    
    Object.values(grouped).forEach(arr => arr.sort((a, b) => a.position - b.position));
    
    const renderChannelItem = (ch, catId = null) => {
        if (![0, 5, 2].includes(ch.type)) return;
        const div = document.createElement('div'); 
        div.id = `channel-${ch.id}`; 
        div.className = `channel-item p-1.5 pl-3 rounded-md cursor-pointer mb-0.5 text-[0.95em] truncate flex items-center relative ${catId ? 'channel-child-'+catId : ''}`; 
        if(catId) div.classList.add('ml-3');
        
        const icon = ch.type === 2 
            ? '<svg class="w-5 h-5 mr-1.5 opacity-60" fill="currentColor" viewBox="0 0 24 24"><path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zm-4 0a8.977 8.977 0 00-6.22 3.32l1.62 1.34C6.54 6.78 7.68 6 9 6c2.37 0 4.54 1.05 5.96 2.7l1.7-1.39A8.932 8.932 0 0010 3.23zM5.16 8.78L2.73 11.2a8.96 8.96 0 000 3.19l2.43 2.43 1.54-1.54-.78-.79c-.28-.56-.45-1.19-.45-1.87s.17-1.3.45-1.86l.78-.78-1.54-1.54z"></path></svg>' 
            : '<span class="text-xl mr-2 text-[var(--text-secondary)] opacity-70">#</span>';
        div.innerHTML = `${icon}<span class="${ch.type===2?'':'font-medium'}">${ch.name}</span>`;
        if (ch.type !== 2) {
             div.onclick = () => selectChannel(ch);
             div.oncontextmenu = (e) => {
                 e.preventDefault();
                 navigator.clipboard.writeText(ch.id).then(()=>alert('„ÉÅ„É£„É≥„Éç„É´ID„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü: '+ch.id));
             };
        } else {
            div.classList.add('opacity-50', 'cursor-not-allowed');
        }
        list.appendChild(div);
    };
    
    (grouped['null'] || []).forEach(ch => renderChannelItem(ch));
    channels.filter(i => i.type === 4).sort((x, y) => x.position - y.position).forEach(cat => {
        const h = document.createElement('div'); 
        h.className = 'px-2 pt-4 pb-1 text-xs font-bold uppercase text-[var(--text-secondary)] hover:text-[var(--text-primary)] cursor-pointer flex items-center select-none group'; 
        h.innerHTML = `<svg class="w-3 h-3 mr-1 category-arrow transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg> ${cat.name}`;
        h.onclick = () => toggleCategory(cat.id, h);
        list.appendChild(h); 
        (grouped[cat.id] || []).forEach(ch => renderChannelItem(ch, cat.id));
    });
    updatePingDots();
}

function toggleCategory(catId, headerEl) {
    const children = document.querySelectorAll(`.channel-child-${catId}`);
    const isCollapsed = headerEl.classList.contains('category-collapsed');
    if (isCollapsed) {
        headerEl.classList.remove('category-collapsed');
        children.forEach(c => c.classList.remove('channel-collapsed'));
    } else {
        headerEl.classList.add('category-collapsed');
        children.forEach(c => c.classList.add('channel-collapsed'));
    }
}

async function selectChannel(ch) {
    if (pollingInterval) clearInterval(pollingInterval);
    currentChannel = ch;
    oldestMessageId = null;
    isLoadingMore = false;
    cancelReply(); 
    attachedFiles = [];
    renderAttachmentList();
    delete pingCounts[ch.id]; updatePingDots();
    
    document.querySelectorAll('.channel-item.active').forEach(e => e.classList.remove('active'));
    const cE = document.getElementById(`channel-${ch.id}`);
    if (cE) cE.classList.add('active');
    
    if (window.innerWidth < 768) showChatView();

    let name = ch.name || 'DM';
    if(ch.recipients && ch.recipients[0]) name = ch.recipients[0].global_name || ch.recipients[0].username;
    
    document.getElementById('channel-name-text').innerHTML = `<span class="text-[var(--text-secondary)] opacity-70 mr-1.5">#</span><span>${name}</span>`;
    
    const container = document.getElementById('message-container');
    container.innerHTML = '<div class="w-full h-full flex items-center justify-center"><div class="loader"></div></div>';
    handleInput(); 
    
    const res = await apiRequest(currentAccount.token, `/channels/${ch.id}/messages?limit=50`);
    container.innerHTML = '';
    
    if (res.error) {
        if (res.status === 401) showLoginScreen(currentAccount);
        container.innerHTML = `<div class="p-8 text-center text-red-500 font-bold">„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
        return;
    }

    const msgs = res.data;
    if (msgs.length > 0) {
        oldestMessageId = msgs[msgs.length - 1].id;
        const fragment = document.createDocumentFragment();
        const arr = msgs.slice().reverse();
        
        arr.forEach((m, i) => {
             if (plugins.messageLogger) messageStore[m.id] = m;
             const prev = (i > 0) ? arr[i-1] : null;
             
             const isGrouped = prev 
                && (prev.author.id === m.author.id) 
                && !m.referenced_message 
                && !m.webhook_id 
                && !prev.webhook_id 
                && m.type === 0 && prev.type === 0
                && (new Date(m.timestamp) - new Date(prev.timestamp) < 5 * 60 * 1000);
             
             const el = createMessageElement(m, isGrouped);
             fragment.appendChild(el);
        });
        container.appendChild(fragment);
        container.scrollTop = container.scrollHeight;
    }

    startPolling();
}

function startPolling() {
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(async () => {
        if (!currentChannel || !currentAccount) return;

        const container = document.getElementById('message-container');
        const lastEl = container.lastElementChild;
        let lastId = null;
        if (lastEl) {
            lastId = lastEl.id.replace('message-', '');
        }

        if (!lastId) return;

        const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages?after=${lastId}`);
        if (res.data && res.data.length > 0) {
            const arr = res.data.reverse(); 
            arr.forEach(m => {
                 if (document.getElementById(`message-${m.id}`)) return;
                 if (plugins.messageLogger) messageStore[m.id] = m;
                 
                 const last = container.lastElementChild;
                 let grp = false;
                 if(last && last.dataset.authorId === m.author.id && !m.referenced_message && m.type === 0) {
                     if(!last.querySelector('.reply-spine')) grp = true; 
                 }
                 
                 const newEl = createMessageElement(m, grp);
                 container.appendChild(newEl);
                 
                 if(m.author.id === currentAccount.id || container.scrollHeight - container.scrollTop - container.clientHeight < 100) {
                     container.scrollTop = container.scrollHeight;
                 }
            });
        }
    }, 1000);
}

async function loadMoreMessages() {
    if (isLoadingMore || !oldestMessageId || !currentChannel) return;
    const container = document.getElementById('message-container');
    
    if (container.scrollTop > 50) return;

    isLoadingMore = true;
    
    const oldScrollHeight = container.scrollHeight;

    const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages?limit=50&before=${oldestMessageId}`);
    
    if (res.data && res.data.length > 0) {
        const messages = res.data;
        oldestMessageId = messages[messages.length - 1].id;

        const fragment = document.createDocumentFragment();
        const arr = messages.reverse();

        let lastBatchAuthId = null;
        let lastBatchTimestamp = 0;

        arr.forEach((m, index) => {
            if (plugins.messageLogger) messageStore[m.id] = m;
            let isGrouped = false;
            if (index > 0) {
                 const timeDiff = new Date(m.timestamp).getTime() - lastBatchTimestamp;
                 if (lastBatchAuthId === m.author.id && !m.referenced_message && !m.webhook_id && timeDiff < 5 * 60 * 1000) {
                     isGrouped = true;
                 }
            }
            const el = createMessageElement(m, isGrouped);
            fragment.appendChild(el);
            lastBatchAuthId = m.author.id;
            lastBatchTimestamp = new Date(m.timestamp).getTime();
        });

        container.prepend(fragment);
        
        const newScrollHeight = container.scrollHeight;
        container.scrollTop = newScrollHeight - oldScrollHeight;
    } else {
        oldestMessageId = null;
    }
    isLoadingMore = false;
}

document.getElementById('message-container').addEventListener('scroll', loadMoreMessages);

function createMessageElement(m, isGrouped) {
    let contentHtml = parseMarkdown(m.content);
    if (m.mentions) {
        m.mentions.forEach(u => { 
            const name = u.global_name || u.username;
            contentHtml = contentHtml.replace(new RegExp(`<@!?${u.id}>`, 'g'), `<span class="bg-[var(--mention-bg)] text-[var(--mention-fg)] px-0.5 rounded cursor-pointer hover:bg-[var(--button-bg)] hover:text-white">@${name}</span>`);
        });
    }
    
    let accessoriesHtml = '';
    if (m.attachments?.length > 0) {
        m.attachments.forEach(a => {
            const isImg = a.content_type?.startsWith('image/');
            const isVid = a.content_type?.startsWith('video/');
            const deletedClass = m.deleted ? 'opacity-50 grayscale' : '';
            if(isImg) {
                accessoriesHtml += `<a href="${a.url}" target="_blank" class="block mt-2"><img src="${a.url}" class="max-w-[300px] max-h-[300px] rounded-lg bg-[var(--bg-tertiary)] object-contain ${deletedClass}" style="display:block;"></a>`;
            } else if(isVid) {
                accessoriesHtml += `<video src="${a.url}" controls class="max-w-[300px] mt-2 rounded-lg bg-black block"></video>`;
            } else {
                accessoriesHtml += `<div class="mt-2 p-3 rounded-md bg-[var(--bg-tertiary)] border border-[var(--border-color)] flex items-center"><a href="${a.url}" target="_blank" class="text-[var(--text-link)] font-mono text-sm">üìé ${a.filename}</a></div>`;
            }
        });
    }

    const el = document.createElement('div'); 
    el.id = `message-${m.id}`; 
    el.className = `message-group ${isGrouped ? 'grouped' : ''} flex flex-col relative w-full ${m.deleted ? 'opacity-80' : ''}`;
    el.dataset.authorId = m.author.id;
    if(m.mentions && m.mentions.some(u=>u.id===currentAccount.id)) el.classList.add('message-mentioned');

    if (plugins.clickAction && !m.deleted) el.addEventListener('dblclick', () => startReply(m));
    if (m.isSending) el.classList.add('message-sending');
    if (m.isFailed) el.classList.add('message-failed');

    let historyHtml = '';
    if(plugins.messageLogger && editedMessages[m.id]) {
        historyHtml = `<div class="text-[var(--text-secondary)] opacity-80 text-sm line-through mb-1 whitespace-pre-wrap">${editedMessages[m.id]}</div>`;
    }

    const isMe = currentAccount && m.author.id === currentAccount.id;
    
    const delBtn = isMe ? `<button onclick="deleteMessage('${m.id}', event)" class="p-1 hover:bg-[var(--bg-primary)] rounded text-red-500" title="ÂâäÈô§"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>` : '';
    const editBtn = isMe ? `<button onclick="startEdit('${m.id}')" class="p-1 hover:bg-[var(--bg-primary)] rounded text-[var(--text-secondary)]" title="Á∑®ÈõÜ"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>` : '';
    const replyBtn = `<button onclick='startReply(${JSON.stringify({id:m.id, author:m.author})})' class="p-1 hover:bg-[var(--bg-primary)] rounded text-[var(--text-secondary)]" title="Ëøî‰ø°"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/></svg></button>`;
    
    el.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        navigator.clipboard.writeText(m.content); 
    });

    const toolbar = `<div class="message-toolbar absolute -top-4 right-4 rounded shadow-sm bg-[var(--bg-secondary)] flex items-center p-0.5 z-20 border border-[var(--border-color)]">${editBtn}${delBtn}${replyBtn}</div>`;

    const editedTag = m.edited_timestamp ? '<span class="edited-tag text-[10px] text-[var(--text-secondary)] ml-1">(edited)</span>' : '';
    let deletedText = m.deleted ? '<span class="text-red-500 ml-1 text-xs">(deleted)</span>' : '';

    const bodyContent = `<div class="message-body whitespace-pre-wrap leading-6 break-words text-[var(--text-primary)] relative">${contentHtml}${editedTag}${deletedText}</div>`;
    const accessoriesContent = accessoriesHtml ? `<div class="message-accessories whitespace-normal mt-1 w-full max-w-full">${accessoriesHtml}</div>` : '';
    const fullContentHtml = `${historyHtml}${bodyContent}${accessoriesContent}`;

    if(m.type === 7) {
        el.className = 'px-4 py-2 opacity-70 flex items-center gap-2 text-green-600 mt-2';
        el.innerHTML = `<span>üëã</span> <b>${m.author.global_name||m.author.username}</b> „ÅåÂèÇÂä†„Åó„Åæ„Åó„Åü„ÄÇ`;
        return el;
    }

    if (isGrouped) {
        el.innerHTML = `
        ${!m.deleted ? toolbar : ''}
        <div class="flex items-start w-full">
            <div style="width:56px;min-width:56px;" class="text-[10px] text-gray-400 text-right pr-2 select-none group-hover:block hidden">${new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
            <div class="flex-1 min-w-0 pr-4">
                ${fullContentHtml}
            </div>
        </div>`.replace(/\n\s+/g, '');
    } 
    else {
        const member = m.member || {}; 
        const name = member.nick || m.author.global_name || m.author.username;
        const avUrl = member.avatar ? `${CDN_BASE}/guilds/${currentChannel.guild_id}/users/${m.author.id}/avatars/${member.avatar}.png?size=64` : (m.author.avatar ? `${CDN_BASE}/avatars/${m.author.id}/${m.author.avatar}.png?size=64` : `${CDN_BASE}/embed/avatars/${m.author.discriminator%5}.png`);
        
        let decoHtml = '';
        if (m.author.avatar_decoration_data) { 
             const decoUrl = `${CDN_BASE}/avatar-decoration-presets/${m.author.avatar_decoration_data.asset}.png?size=96`; 
             decoHtml = `<img src="${decoUrl}" class="avatar-decoration">`; 
        }

        const date = new Date(m.timestamp);
        const y = date.getFullYear(); const mo = ('0'+(date.getMonth()+1)).slice(-2); const d = ('0'+date.getDate()).slice(-2);
        const h = ('0'+date.getHours()).slice(-2); const mi = ('0'+date.getMinutes()).slice(-2); const s = ('0'+date.getSeconds()).slice(-2);
        const timeStr = `${y} ${mo}/${d} ${h}:${mi}:${s}`;
        
        const usernameDisp = plugins.showMeYourName ? `<span class="ml-1 text-[0.8em] font-medium text-[var(--text-secondary)] opacity-70">@${m.author.username}</span>` : '';
        const botTag = m.author.bot ? `<span class="ml-1.5 bg-[#5865F2] text-white text-[0.625rem] px-1.5 rounded-[0.1875rem] py-[1px] font-medium align-middle">BOT</span>` : '';

        let refHtml = '';
        if (m.referenced_message) {
            const rm = m.referenced_message;
            const refName = rm.author ? (rm.author.global_name || rm.author.username) : "Unknown";
            const refAv = rm.author && rm.author.avatar ? `${CDN_BASE}/avatars/${rm.author.id}/${rm.author.avatar}.png?size=16` : `${CDN_BASE}/embed/avatars/0.png`;
            refHtml = `
            <div class="flex items-center gap-1 ml-[56px] mb-1 opacity-70 text-sm cursor-pointer hover:opacity-100 relative w-fit" onclick="scrollToMessage('${rm.id}')">
                <div class="reply-spine"></div>
                <img src="${refAv}" class="w-4 h-4 rounded-full">
                <span class="font-bold mr-1 truncate max-w-[200px] text-xs">@${refName}</span>
                <span class="truncate max-w-[300px] text-xs">${rm.content || 'Content'}</span>
            </div>`;
        }

        let nameStyle = m.member?.color ? `style="color:#${m.member.color.toString(16).padStart(6,'0')}"` : '';

        el.innerHTML = `
        ${refHtml}
        ${!m.deleted ? toolbar : ''} 
        <div class="flex mt-0.5 items-start w-full relative">
            <div class="mr-4 ml-4 relative flex-shrink-0 avatar-container">
                <img src="${avUrl}" class="avatar-img shadow-sm hover:shadow-md transition-shadow rounded-full">
                ${decoHtml}
            </div>
            <div class="flex-1 min-w-0 pr-4">
                <div class="flex items-baseline leading-tight mb-1">
                    <span class="font-medium mr-1 cursor-pointer hover:underline" ${nameStyle}>${name}</span>
                    ${usernameDisp}${botTag}
                    <span class="ml-2 text-xs text-[var(--text-secondary)]" title="${timeStr}">${timeStr}</span>
                </div>
                ${fullContentHtml}
            </div>
        </div>`.replace(/\n\s+/g, ' ');
    }
    
    if(m.isFailed) {
        el.insertAdjacentHTML('beforeend', 
            `<div class="mt-1 ml-[56px] text-sm text-[var(--text-secondary)]">
                <div class="flex items-center gap-1 mb-1 text-red-400">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    ÈÄÅ‰ø°„Ç®„É©„Éº: ${m.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'}
                </div>
                <div class="text-xs">
                     Clyde ‚Ä¢ „ÅÇ„Å™„Åü„Å†„Åë„Å´Ë°®Á§∫ ‚Ä¢ <span class="text-blue-400 cursor-pointer hover:underline" onclick="document.getElementById('message-${m.id}').remove()">„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§</span>
                </div>
            </div>`
        );
    }
    
    const contentText = el.querySelector('.message-body');
    if(contentText) contentText.dataset.originalContent = m.content;

    return el;
}

async function sendMessage() {
    if (!currentChannel || !currentAccount) return;
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    if (!content && attachedFiles.length === 0) return;

    if (content.length > maxCharCount) {
         alert(`ÊñáÂ≠óÊï∞„Ç™„Éº„Éê„Éº (${content.length}/${maxCharCount})„ÄÇ„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶ÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ`);
         const blob = new Blob([content], { type: 'text/plain' });
         const file = new File([blob], 'message.txt', { type: 'text/plain' });
         if(attachedFiles.length < 10) attachedFiles.push(file);
         else return alert('Ê∑ª‰ªò„Éï„Ç°„Ç§„É´Âà∂Èôê„Åß„Åô');
         input.value = '';
    }

    const now = new Date();
    const tempId = `temp-${now.getTime()}`;
    const fakeMsg = { 
        id: tempId, author: currentAccount, content: (content.length>maxCharCount ? '' : content), 
        timestamp: now.toISOString(), isSending: true,
        attachments: attachedFiles.map(f=>({url:'#',filename:f.name, content_type:f.type}))
    };
    
    const container = document.getElementById('message-container');
    const lastEl = container.lastElementChild;
    let isGrouped = false;
    if(lastEl && lastEl.dataset.authorId === currentAccount.id && !lastEl.classList.contains('message-failed')) {
        isGrouped = true;
    }
    const fakeEl = createMessageElement(fakeMsg, isGrouped);
    container.appendChild(fakeEl);
    container.scrollTop = container.scrollHeight;

    input.value = ''; 
    const filesToSend = [...attachedFiles];
    attachedFiles = [];
    renderAttachmentList();
    handleInput();

    const body = new FormData();
    body.append('payload_json', JSON.stringify({ 
        content: fakeMsg.content, 
        message_reference: replyingTo ? { message_id: replyingTo.messageId } : undefined 
    }));
    filesToSend.forEach((f, i) => body.append(`files[${i}]`, f));

    const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages`, 'POST', body, true);
    
    if (res.error) {
        const errEl = document.getElementById(`message-${tempId}`);
        if(errEl) {
             const failedMsg = { ...fakeMsg, isSending:false, isFailed:true, error: res.error.message };
             const newEl = createMessageElement(failedMsg, errEl.classList.contains('grouped'));
             errEl.replaceWith(newEl);
        }
    } else {
        const okEl = document.getElementById(`message-${tempId}`);
        if(okEl) okEl.remove();
        cancelReply();
    }
}

function handleInput() {
    const i = document.getElementById('message-input');
    const s = document.getElementById('send-button');
    const ctr = document.getElementById('char-counter');
    
    i.style.height = 'auto'; i.style.height = (i.scrollHeight) + 'px';
    const len = i.value.length;
    s.disabled = (len === 0 && attachedFiles.length === 0);
    
    if(plugins.showCharacter) {
        ctr.classList.remove('opacity-0');
        ctr.textContent = `${len} / ${maxCharCount}`;
        ctr.style.color = (len > maxCharCount) ? '#ed4245' : 'var(--text-secondary)';
    } else {
        ctr.classList.add('opacity-0');
    }
}

function deleteAccount(id, e) {
    if(e) e.stopPropagation(); 
    if (!e.shiftKey && !confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
    let a = getAccounts(); a = a.filter(acc => acc.id !== id); saveAccounts(a);
    if (getActiveAccountId() === id || !getActiveAccountId()) { localStorage.removeItem('activeAccountId'); showLoginScreen(); }
    else { renderSavedAccountsList(); renderCurrentUserPanel(); }
}

async function deleteMessage(id, e) {
    if (e.shiftKey || confirm("„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) { 
        await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages/${id}`, 'DELETE'); 
    }
}

function startEdit(id) { 
    const msgEl = document.getElementById(`message-${id}`); 
    if (!msgEl) return; 
    const contentEl = msgEl.querySelector('.message-body'); 
    if (!contentEl) return; 
    const original = contentEl.dataset.originalContent || "";
    
    contentEl.innerHTML = `<textarea class="input-field w-full p-2 bg-[var(--bg-tertiary)] rounded outline-none h-auto border border-blue-500 font-sans" rows="3">${original}</textarea><div class="text-xs mt-1 text-[var(--text-link)] opacity-80">Enter„Åß‰øùÂ≠ò - Esc„Åß„Ç≠„É£„É≥„Çª„É´</div>`; 
    const t = contentEl.querySelector('textarea'); 
    t.focus(); 
    t.onkeydown = async (e) => { 
        if(e.key==='Enter' && !e.shiftKey) { 
            e.preventDefault(); 
            await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages/${id}`, 'PATCH', {content: t.value}); 
        } else if(e.key==='Escape'){ 
            const m = messageStore[id];
            if(m) {
                 const newEl = createMessageElement(m, msgEl.classList.contains('grouped'));
                 msgEl.replaceWith(newEl);
            }
        } 
    };
}

function startReply(m) { 
    replyingTo = { messageId: m.id, author: m.author }; 
    const bar = document.getElementById('reply-bar');
    bar.classList.remove('hidden'); bar.classList.add('flex'); 
    document.getElementById('reply-username').innerText = m.author.global_name || m.author.username; 
    document.getElementById('message-input').focus(); 
}

function cancelReply() { 
    replyingTo = null; 
    const bar = document.getElementById('reply-bar');
    bar.classList.remove('flex'); bar.classList.add('hidden'); 
}

function scrollToMessage(id) {
    const el = document.getElementById(`message-${id}`);
    if (el) {
        el.scrollIntoView({ behavior: 'auto', block: 'center' });
        el.style.backgroundColor = 'rgba(250, 233, 105, 0.3)';
        setTimeout(() => el.style.backgroundColor = '', 1500);
    }
}

function parseMarkdown(t) { 
    if (!t) return ''; 
    return t.replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-[var(--text-link)] hover:underline">$1</a>')
        .replace(/\n/g, '<br>'); 
}

function renderSettingsModal() {
    switchSettingsTab('plugins');
    renderPluginList();
    renderThemeTab();
    document.getElementById('settings-modal').classList.remove('hidden');
}

function switchSettingsTab(tabName) {
    document.querySelectorAll('.settings-tab-item').forEach(e => e.classList.remove('active'));
    document.getElementById(`tab-btn-${tabName}`).classList.add('active');
    document.getElementById('tab-content-plugins').classList.add('hidden');
    document.getElementById('tab-content-general').classList.add('hidden');
    document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
}

function renderPluginList() {
    const list = document.getElementById('plugin-list'); 
    list.innerHTML = '';
    const defs = [
        { key: 'clickAction', name: 'Double Click Reply', desc: '„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ëøî‰ø°„Åó„Åæ„Åô' },
        { key: 'showMeYourName', name: 'Show Me Your Name', desc: '„É¶„Éº„Ç∂„ÉºÂêç„ÅÆÊ®™„Å´(@username)„ÇíË°®Á§∫' },
        { key: 'sendSeconds', name: 'SendSeconds', desc: 'ÈÄÅ‰ø°ÊôÇÂàª„ÅÆÁßíÊï∞„Åæ„ÅßË°®Á§∫' },
        { key: 'messageLogger', name: 'MessageLogger', desc: 'ÂâäÈô§/Á∑®ÈõÜÂ±•Ê≠¥„Çí‰øùÊåÅ„Åó„Å¶Ë°®Á§∫' },
        { key: 'showCharacter', name: 'Show Character Count', desc: 'ÊñáÂ≠óÊï∞„ÇíÂÖ•ÂäõÊ¨Ñ„ÅÆÂè≥‰∏ã„Å´Ë°®Á§∫' }
    ];
    defs.forEach(p => {
        const item = document.createElement('div');
        item.className = "plugin-item";
        item.innerHTML = `<div><div class="font-bold text-[var(--text-primary)]">${p.name}</div><div class="text-xs text-[var(--text-secondary)] mt-0.5">${p.desc}</div></div><label class="switch"><input type="checkbox" ${plugins[p.key]?'checked':''} data-key="${p.key}"><span class="slider"></span></label>`;
        item.querySelector('input').onchange = (e) => {
            plugins[p.key] = e.target.checked;
            localStorage.setItem('plugins', JSON.stringify(plugins));
            handleInput(); 
        }
        list.appendChild(item);
    });
    const gh = document.createElement('div');
    gh.innerHTML = `<a href="https://github.com/Bloxd-H/discord_lite" target="_blank" class="text-xs text-blue-500 hover:underline block mt-4 text-center">GitHub Repository</a>`;
    list.appendChild(gh);
}

function renderThemeTab() {
    const current = localStorage.theme || 'dark';
    document.getElementById('theme-check-dark').classList.toggle('hidden', current !== 'dark');
    document.getElementById('theme-check-light').classList.toggle('hidden', current !== 'light');
}

function setTheme(mode) {
    if(mode === 'dark') {
        document.documentElement.classList.add('dark');
        localStorage.theme = 'dark';
    } else {
        document.documentElement.classList.remove('dark');
        localStorage.theme = 'light';
    }
    renderThemeTab();
}

async function addAccount(token, existingId = null) {
    document.getElementById('login-error').innerText = "";
    if (!token || !token.trim()) return;
    token = token.trim().replace(/^"|"$/g, '');
    
    const result = await apiRequest(token, '/users/@me');
    if (result.data && result.data.id) {
        let a = getAccounts(); 
        if(existingId && existingId !== result.data.id) return document.getElementById('login-error').innerText = "Âà•„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÅÆ„Éà„Éº„ÇØ„É≥„Åß„Åô";
        const idx = a.findIndex(acc => acc.id === result.data.id);
        const n = { ...result.data, token };
        if (idx > -1) a[idx] = n; else a.push(n);
        saveAccounts(a); switchAccount(result.data.id);
    } else { 
        document.getElementById('login-error').innerText = `„Ç®„É©„Éº: ${result.error?.message || 'ÁÑ°Âäπ„Å™„Éà„Éº„ÇØ„É≥'}`; 
    }
}
</script>

    </body>
</html>
