<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script> tailwind.config = { darkMode: 'class' } </script>
    <script src="https://hcaptcha.com/1/api.js?onload=onHCaptchaLoad&render=explicit" async defer></script>
    <style>
        :root { --bg-primary: #f5f5f5; --bg-secondary: #ffffff; --bg-tertiary: #e0e0e0; --bg-quaternary: #ebebeb; --text-primary: #111111; --text-secondary: #555555; --text-link: #007bff; --border-color: #cccccc; --button-bg: #5865f2; --button-text: #fff; --hover-bg: #f0f0f0; --active-bg: #e0e0e0; }
        html.dark { --bg-primary: #36393f; --bg-secondary: #2f3136; --bg-tertiary: #202225; --bg-quaternary: #292b2f; --text-primary: #e0e0e0; --text-secondary: #b9bbbe; --text-link: #58a6ff; --border-color: #40444b; --button-bg: #5865f2; --button-text: #ffffff; --hover-bg: #3a3c41; --active-bg: #40444b; }
        body { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .server-icon { width: 50px; height: 50px; border-radius: 50%; transition: border-radius 0.2s ease; }
        .server-icon:hover, .server-icon.active { border-radius: 15px; }
        .channel-item:hover { background-color: var(--hover-bg); }
        .channel-item.active { background-color: var(--active-bg); font-weight: bold; }
        .input-field { background-color: var(--bg-quaternary); border: 1px solid var(--border-color); color: var(--text-primary); }
        .message-content img { max-width: 400px; max-height: 300px; border-radius: 8px; margin-top: 5px; }
        .loader { border: 4px solid var(--bg-tertiary); border-top: 4px solid var(--button-bg); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #captcha-modal-overlay { background-color: rgba(0,0,0,0.7); }
        #captcha-modal-content { background-color: var(--bg-secondary); }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--bg-secondary); } ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="font-sans h-screen flex flex-col">
    <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (å¤‰æ›´ãªã—) -->
    <div id="auth-section" class="w-full max-w-md mx-auto my-auto p-8 rounded-lg shadow-xl" style="background-color: var(--bg-secondary);"><h1 class="text-2xl font-bold text-center mb-2">Welcome back!</h1><p class="text-center text-sm mb-6" style="color:var(--text-secondary)">We're so excited to see you again!</p><div id="login-error" class="text-red-500 text-xs mb-3"></div><form id="login-form" class="space-y-4"><div><label for="email" class="text-xs font-bold uppercase" style="color:var(--text-secondary)">Email</label><input type="email" id="email" class="input-field w-full p-2.5 rounded-md text-sm mt-1" required></div><div><label for="password" class="text-xs font-bold uppercase" style="color:var(--text-secondary)">Password</label><input type="password" id="password" class="input-field w-full p-2.5 rounded-md text-sm mt-1" required></div><button type="submit" id="login-button" class="bg-blue-600 hover:bg-blue-700 w-full px-4 py-3 rounded-md font-bold text-white flex items-center justify-center"><span id="login-button-text">Login</span><div id="login-spinner" class="loader hidden"></div></button></form></div>
    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª (å¤‰æ›´ãªã—) -->
    <div id="main-app" class="hidden flex-1 flex min-h-0"><div class="w-20 p-2 flex flex-col items-center gap-2 overflow-y-auto" style="background-color: var(--bg-tertiary);"><div id="guild-list" class="flex flex-col items-center gap-2"></div></div><div class="flex-1 flex min-h-0" style="background-color: var(--bg-secondary);"><div id="channel-panel" class="hidden w-60 p-2 flex-col border-r" style="border-color: var(--border-color);"><div class="flex justify-between items-center p-2 mb-2"><h2 id="guild-name" class="font-bold text-lg truncate"></h2><button onclick="logout()" title="Logout" class="text-red-500 hover:text-red-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg></button></div><div id="channel-list" class="flex-1 overflow-y-auto space-y-1"></div></div><div id="chat-section" class="hidden flex-1 flex flex-col min-h-0"><div class="p-3 border-b flex items-center justify-between" style="border-color: var(--border-color);"><div class="flex items-center gap-2"><span class="text-2xl" style="color:var(--text-secondary)">#</span><div id="current-ch-name" class="font-bold text-lg"></div></div><div id="ws-status" class="w-3 h-3 rounded-full bg-gray-500" title="WebSocket Disconnected"></div></div><div id="message-container" class="flex-1 overflow-y-auto p-4 space-y-4"></div><div class="p-4 border-t" style="border-color: var(--border-color);"><input type="text" id="message-input" placeholder="Message..." class="input-field w-full p-3 rounded-md" disabled></div></div></div></div>
    <!-- Captchaãƒ¢ãƒ¼ãƒ€ãƒ« (å¤‰æ›´ãªã—) -->
    <div id="captcha-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center"><div id="captcha-modal-overlay" class="absolute inset-0"></div><div id="captcha-modal-content" class="relative p-8 rounded-lg shadow-xl text-center"><h3 class="text-xl font-bold mb-4">Verification Required</h3><p class="text-sm mb-4" style="color:var(--text-secondary)">Please complete the challenge below to continue.</p><div id="captcha-box" class="flex justify-center"></div></div></div>

    <script>
        const LOGIN_PROXY_URL = '/api/login';
        const API_BASE_URL = 'https://discord.com/api/v9';
        const GATEWAY_URL = 'wss://gateway.discord.gg/?v=9&encoding=json';
        let userToken = null;
        let ws = null;

        let hCaptchaLoaded = false;
        let captchaQueue = [];
        let isCaptchaVisible = false;

        function onHCaptchaLoad() { hCaptchaLoaded = true; }
        window.addEventListener('DOMContentLoaded', () => { initTheme(); document.getElementById('login-form').addEventListener('submit', handleLogin); const storedToken = localStorage.getItem('token'); if (storedToken) loginWithToken(storedToken.replace(/"/g, '')); });
        function initTheme() { if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');}
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('login-button');
            const buttonText = document.getElementById('login-button-text');
            const spinner = document.getElementById('login-spinner');
            const errorDiv = document.getElementById('login-error');

            const toggleSpinner = (show) => {
                loginButton.disabled = show;
                buttonText.classList.toggle('hidden', show);
                spinner.classList.toggle('hidden', !show);
            };

            errorDiv.textContent = '';
            toggleSpinner(true);

            let captchaResult = null;
            let maxRetries = 2;

            while (maxRetries-- > 0) {
                try {
                    const payload = { 
                        login: email, 
                        password: password, 
                        captcha_key: captchaResult ? captchaResult.key : null,
                        captcha_rqtoken: captchaResult ? captchaResult.rqtoken : null 
                    };
                    const response = await fetch(LOGIN_PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        if (data.token) {
                            toggleSpinner(false);
                            loginWithToken(data.token);
                            return;
                        } else if (data.mfa) {
                            throw new Error('Two-factor authentication is required.');
                        }
                    } else if (response.status === 400 && data.captcha_key) {
                        captchaResult = await solveCaptcha(data.captcha_sitekey, data.captcha_rqdata);
                    } else {
                        throw new Error(data.message || data.errors?.login?._errors?.[0]?.message || 'Login failed');
                    }
                } catch (error) {
                    errorDiv.textContent = `Login Error: ${error.message}`;
                    break;
                }
            }
            toggleSpinner(false);
        }

        async function loginWithToken(token) { userToken = token; const user = await apiRequest('/users/@me'); if (user?.id) { localStorage.setItem('token', userToken); document.getElementById('auth-section').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden'); initializeApp(); } else { logout(); } }
        function logout() { localStorage.removeItem('token'); userToken = null; if (ws) ws.close(); document.getElementById('auth-section').classList.remove('hidden'); document.getElementById('main-app').classList.add('hidden'); }
        async function initializeApp() { await loadGuilds(); connectWebSocket(); }
        
        function solveCaptcha(sitekey, rqdata) {
            return new Promise((resolve, reject) => {
                captchaQueue.push({
                    captcha: { captcha_sitekey: sitekey, captcha_rqdata: rqdata },
                    resolve: resolve,
                    reject: () => reject(new Error('Captcha process failed.')),
                });
                processCaptchaQueue();
            });
        }
        
        function initCaptcha(sitekey, rqdata) {
            if (!hCaptchaLoaded) { alert("hCaptcha is not ready."); return; }
            const captchaBox = document.getElementById("captcha-box");
            if(captchaBox.innerHTML !== "") { hcaptcha.reset(); return; } 
            const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const widgetId = window.hcaptcha.render("captcha-box", { sitekey, theme, callback: onCaptchaSuccess });
            if (rqdata) {
                hcaptcha.setData(widgetId, { rqdata: rqdata });
            }
        }
        
        function processCaptchaQueue() {
            if (isCaptchaVisible || captchaQueue.length === 0) return;
            isCaptchaVisible = true;
            const task = captchaQueue[0];
            document.getElementById('captcha-modal').classList.remove('hidden');
            initCaptcha(task.captcha.captcha_sitekey, task.captcha.captcha_rqdata);
        }

        async function onCaptchaSuccess(key) {
            isCaptchaVisible = false;
            document.getElementById('captcha-modal').classList.add('hidden');
            document.getElementById('captcha-box').innerHTML = ""; 
            const task = captchaQueue.shift();
            if (!task) return;
            const rqtoken = hcaptcha.getRespKey(Object.keys(hcaptcha.getwidgets())[0]);
            
            if (task.resolve) {
                task.resolve({ key: key, rqtoken: rqtoken });
            } 
            else if (task.request) {
                const result = await apiRequest(task.request.path, task.request.method, task.request.bodyData, { key, rqtoken });
                processCaptchaQueue();
            }
        }
        
        async function apiRequest(path, method = 'GET', bodyData = null, captchaData = null) { if (!userToken) return null; try { const headers = { 'Authorization': userToken, 'Content-Type': 'application/json', 'X-Super-Properties': 'eyJvcyI6IldpbmRvd3MiLCJicm93c2VyIjoiQ2hyb21lIiwiZGV2aWNlIjoiIiwic3lzdGVtX2xvY2FsZSI6ImphIiwiaGFzX2NsaWVudF9tb2RzIjpmYWxzZSwiYnJvd3Nlcl91c2VyX2FnZW50IjoiTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzE0Mi4wLjAuMCBTYWZhcmkvNTM3LjM2IiwiYnJvd3Nlcl92ZXJzaW9uIjoiMTQyLjAuMC4wIiwib3NfdmVyc2lvbiI6IjEwIiwicmVmZXJyZXIiOiIiLCJyZWZlcnJpbmdfZG9tYWluIjoiIiwicmVmZXJyZXJfY3VycmVudCI6IiIsInJlZmVycmluZ19kb21haW5fY3VycmVudCI6IiIsInJlbGVhc2VfY2hhbm5lbCI6InN0YWJsZSIsImNsaWVudF9idWlsZF9udW1iZXIiOjQ3OTIxOSwiY2xpZW50X2V2ZW50X3NvdXJjZSI6bnVsbCwiY2xpZW50X2xhdW5jaF9pZCI6IjZhYjNmNmQ4LThlM2MtNDE5OS1hOWE0LWU3Y2M3NGJjODY1ZSIsImxhdW5jaF9zaWduYXR1cmUiOiI3ZjU2ODg0Ni1jNDY3LTQ2MTMtODQ1Ni0yYjg3MjIzNGQyMzEiLCJjbGllbnRfYXBwX3N0YXRlIjoiZm9jdXNlZCJ9', 'X-Fingerprint': '1449055427177484542.uPo_4AUwKCGfP26zh4-mzEnO6yk'}; if (captchaData) { headers['x-captcha-key'] = captchaData.key; headers['x-captcha-rqtoken'] = captchaData.rqtoken; } const options = { method, headers }; if (bodyData) options.body = JSON.stringify(bodyData); const response = await fetch(API_BASE_URL + path, options); if (response.status === 401) { logout(); return null; } const responseData = (response.status === 204) ? {} : await response.json(); if (response.status === 400 && responseData.captcha_key) { const result = await solveCaptcha(responseData.captcha_sitekey, responseData.captcha_rqdata); return apiRequest(path, method, bodyData, result); } if (!response.ok) { console.error(`API Error ${response.status}:`, responseData); return null; } return responseData; } catch (e) { console.error('API Request failed:', e); return null; } }
        let currentGuildId, currentChannelId, guildsCache = [], channelsCache = {}; let sessionId, heartbeatInterval, lastSequence;
        async function loadGuilds() { /* ... no changes ... */ const [settings, guilds] = await Promise.all([apiRequest('/users/@me/settings'),apiRequest('/users/@me/guilds')]); if (!guilds) return; guildsCache = guilds; const sortedGuilds = [...guilds].sort((a, b) => { const posA = settings?.guild_positions?.indexOf(a.id) ?? -1; const posB = settings?.guild_positions?.indexOf(b.id) ?? -1; return (posA === -1 ? Infinity : posA) - (posB === -1 ? Infinity : posB); }); const container = document.getElementById('guild-list'); container.innerHTML = ''; sortedGuilds.forEach(g => { const img = document.createElement('img'); img.id = `guild-${g.id}`; img.className = 'server-icon bg-gray-700 object-cover cursor-pointer'; img.src = g.icon ? `https://cdn.discordapp.com/icons/${g.id}/${g.icon}.webp?size=128` : 'https://cdn.discordapp.com/embed/avatars/0.png'; img.title = g.name; img.onclick = () => loadChannels(g.id); container.appendChild(img); }); }
        async function loadChannels(guildId) { /* ... no changes ... */ currentGuildId = guildId; currentChannelId = ''; document.querySelectorAll('.server-icon').forEach(el => el.classList.remove('active')); document.getElementById(`guild-${guildId}`).classList.add('active'); const guild = guildsCache.find(g => g.id === guildId); document.getElementById('guild-name').innerText = guild?.name; document.getElementById('channel-panel').classList.remove('hidden'); document.getElementById('chat-section').classList.add('hidden'); const channels = await apiRequest(`/guilds/${guildId}/channels`); if (!channels) return; channelsCache[guildId] = channels; const container = document.getElementById('channel-list'); container.innerHTML = ''; channels.filter(c => c.type === 0).sort((a,b) => a.position - b.position).forEach(c => { const el = document.createElement('div'); el.id = `channel-${c.id}`; el.className = 'channel-item p-2 rounded-md cursor-pointer text-sm truncate'; el.innerText = `# ${c.name}`; el.onclick = () => selectChannel(c); container.appendChild(el); }); }
        async function selectChannel(channel) { /* ... no changes ... */ currentChannelId = channel.id; document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active')); document.getElementById(`channel-${channel.id}`).classList.add('active'); document.getElementById('chat-section').classList.remove('hidden'); document.getElementById('current-ch-name').innerText = channel.name; document.getElementById('message-container').innerHTML = ''; document.getElementById('message-input').disabled = false; const messages = await apiRequest(`/channels/${channel.id}/messages?limit=50`); if (messages) { messages.slice().reverse().forEach(renderMessage); scrollToBottom(); } }
        function renderMessage(msg) { /* ... no changes ... */ const container = document.getElementById('message-container'); const div = document.createElement('div'); const displayName = msg.author.global_name || msg.author.username; const avatarUrl = msg.author.avatar ? `https://cdn.discordapp.com/avatars/${msg.author.id}/${msg.author.avatar}.webp?size=64` : `https://cdn.discordapp.com/embed/avatars/${(msg.author.discriminator || 0) % 5}.png`; let contentHTML = msg.content.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/(https?:\/\/[^\s]+)/g, `<a href="$1" target="_blank" class="hover:underline" style="color:var(--text-link);">${'$1'}</a>`); if (msg.attachments?.length > 0) msg.attachments.forEach(att => { contentHTML += att.content_type?.startsWith('image/') ? `<br><a href="${att.url}" target="_blank"><img src="${att.url}" class="message-content" alt="Attachment"></a>` : `<br><div class="mt-2 p-2 rounded-md" style="background-color: var(--bg-quaternary);">ðŸ“Ž <a href="${att.url}" target="_blank" class="hover:underline" style="color:var(--text-link);">${att.filename}</a></div>`; }); div.innerHTML = `<div class="flex gap-4 py-1"><img src="${avatarUrl}" class="w-10 h-10 rounded-full flex-shrink-0 mt-1"><div><div><span class="font-bold">${displayName}</span><span class="text-xs ml-2" style="color:var(--text-secondary)">${new Date(msg.timestamp).toLocaleString()}</span></div><div style="word-wrap:break-word;">${contentHTML}</div></div></div>`; const shouldScroll = container.scrollTop + container.clientHeight >= container.scrollHeight - 30; container.appendChild(div); if (shouldScroll) scrollToBottom(); }
        async function sendMessage() { /* ... no changes ... */ const input = document.getElementById('message-input'); const content = input.value.trim(); if (!content || !currentChannelId) return; input.value = ''; await apiRequest(`/channels/${currentChannelId}/messages`, 'POST', { content: content, nonce: `temp_${Date.now()}` }); }
        function connectWebSocket() { /* ... no changes ... */ ws = new WebSocket(GATEWAY_URL); ws.onopen = () => console.log('WebSocket Connected'); ws.onmessage = onWebSocketMessage; ws.onclose = () => { console.warn('WebSocket disconnected.'); updateWsStatus(false); clearInterval(heartbeatInterval); }; ws.onerror = (error) => console.error('WebSocket Error:', error); }
        function onWebSocketMessage(event) { /* ... no changes ... */ const payload = JSON.parse(event.data); if (payload.s) lastSequence = payload.s; switch (payload.op) { case 0: handleDispatch(payload.t, payload.d); break; case 1: sendHeartbeat(); break; case 10: startHeartbeat(payload.d.heartbeat_interval); identify(); break; } }
        function handleDispatch(type, data) { /* ... no changes ... */ if (type === 'READY') { sessionId = data.session_id; updateWsStatus(true); console.log('Gateway Ready.'); } else if (type === 'MESSAGE_CREATE' && data.channel_id === currentChannelId) { renderMessage(data); } }
        function startHeartbeat(ms) { /* ... no changes ... */ if (heartbeatInterval) clearInterval(heartbeatInterval); sendHeartbeat(); heartbeatInterval = setInterval(sendHeartbeat, ms); }
        function sendHeartbeat() { /* ... no changes ... */ if (ws?.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ op: 1, d: lastSequence })); }
        function identify() { /* ... no changes ... */ ws.send(JSON.stringify({ op: 2, d: { token: userToken, properties: { os: "Windows", browser: "Chrome", device: "" }, compress: false } })); }
        function updateWsStatus(isConnected) { /* ... no changes ... */ const statusIndicator = document.getElementById('ws-status'); statusIndicator.classList.toggle('bg-green-500', isConnected); statusIndicator.classList.toggle('bg-gray-500', !isConnected); }
        document.getElementById('message-input').addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        function scrollToBottom() { /* ... no changes ... */ const el = document.getElementById('message-container'); el.scrollTop = el.scrollHeight; }
    </script>
</body>
</html>
