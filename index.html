<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>avoidcord</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class'
            }
        </script>
<style>
    :root {
        --bg-primary: #f5f5f5;
        --bg-secondary: #ffffff;
        --bg-tertiary: #e0e0e0;
        --bg-quaternary: #ebebeb;
        --text-primary: #111111;
        --text-secondary: #555555;
        --text-link: #4f89e2;
        --border-color: #cccccc;
        --button-bg: #5865f2;
        --button-text: #fff;
        --hover-bg: #f0f0f0;
        --active-bg: #e0e0e0;
        --mention-bg: rgba(88, 101, 242, 0.1);
        --mention-fg: #5865f2;
        --system-bg: rgba(88, 166, 255, 0.1);
        --status-online: #3ba55d;
        --status-idle: #faa81a;
        --status-dnd: #ed4245;
        --status-offline: #747f8d;
    }

    html.dark {
        --bg-primary: #36393f;
        --bg-secondary: #2f3136;
        --bg-tertiary: #202225;
        --bg-quaternary: #292b2f;
        --text-primary: #e0e0e0;
        --text-secondary: #b9bbbe;
        --text-link: #58a6ff;
        --border-color: #40444b;
        --button-bg: #5865f2;
        --button-text: #ffffff;
        --hover-bg: #3a3c41;
        --active-bg: #40444b;
        --mention-bg: rgba(88, 101, 242, 0.15);
        --mention-fg: #7289da;
        --system-bg: rgba(88, 166, 255, 0.1);
    }

    html.dark .input-field {
        color: var(--text-primary);
    }

    .server-icon, .channel-item {
        position: relative;
    }

    .server-icon {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
    }
    
    .server-icon.active img, .server-icon.active div {
        border-radius: 0.5rem;
        transition: border-radius 0.5s ease-in-out;
    }


    .ping-dot {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 10px;
        height: 10px;
        background-color: #f84a4b;
        border-radius: 50%;
        border: 2px solid var(--bg-tertiary);
        z-index: 10;
    }

    .channel-item .ping-dot {
        bottom: 10px;
        right: 10px;
    }

    .channel-item.active {
        background-color: var(--active-bg);
    }

    .loader {
        border: 4px solid var(--bg-tertiary);
        border-top: 4px solid var(--button-bg);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--bg-tertiary);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .mention {
        color: var(--mention-fg);
        background-color: var(--mention-bg);
        padding: 0 2px;
        border-radius: 3px;
        font-weight: 500;
        cursor: pointer;
    }

    .message-group:hover .message-toolbar {
        visibility: visible;
        opacity: 1;
    }

    .message-toolbar {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.1s ease-in-out;
    }

    .status-dot {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 3px solid var(--bg-secondary);
        z-index: 5;
    }

    .status-dot.online { background-color: var(--status-online); }
    .status-dot.idle { background-color: var(--status-idle); }
    .status-dot.dnd { background-color: var(--status-dnd); }
    .status-dot.offline { background-color: var(--status-offline); }
</style>
    </head>
    <body class="font-sans h-screen flex flex-col overflow-hidden bg-gray-200 dark:bg-gray-800 text-[var(--text-primary)]">
        <div id="auth-section" class="w-full max-w-md m-auto p-8 rounded-lg shadow-xl flex-col bg-white dark:bg-gray-700 hidden">
            <h1 class="text-2xl font-bold text-center mb-2">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</h1>
            <div id="login-error" class="text-red-500 text-xs mb-3 text-center"></div>
            <form class="space-y-4" onsubmit="return false;">
                <input type="password" id="token-input" class="input-field w-full p-2.5 rounded-md" placeholder="Discord Token">
                <button type="button" id="add-account-button" class="bg-blue-600 hover:bg-blue-700 w-full py-3 rounded-md font-bold text-white flex justify-center items-center">
                    <span id="add-account-button-text">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</span>
                    <div id="login-spinner" class="loader hidden"></div>
                </button>
                <button type="button" id="cancel-add-account-button" class="bg-gray-600 hover:bg-gray-700 w-full py-2 rounded-md font-bold text-white">„Ç≠„É£„É≥„Çª„É´</button>
            </form>
        </div>
        <div id="main-app" class="hidden flex-1 flex-row min-h-0 relative">
            <div id="sidebar-view" class="flex flex-row w-full h-full md:w-auto md:flex">
                <div class="p-2 flex flex-col items-center gap-2 overflow-y-auto flex-shrink-0" style="background-color: var(--bg-tertiary);">
                    <div id="dm-icon" title="DM" class="server-icon bg-indigo-600 flex items-center justify-center cursor-pointer text-white font-black text-xl mb-1">DM</div>
                    <div id="guild-list" class="flex flex-col items-center gap-2 w-full"></div>
                    <div class="mt-auto flex flex-col gap-2 pt-4">
                        <button id="theme-toggle-btn" class="server-icon bg-gray-500 hover:bg-gray-600 flex items-center justify-center text-white" title="„ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà"></button>
                        <a href="https://github.com/zuotengyangyin0-ui/discord_lite" target="_blank" class="server-icon bg-gray-700 hover:bg-gray-800 text-white flex items-center justify-center" title="GitHub">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0C5.373 0 0 5.373 0 12c0 5.303 3.438 9.8 8.207 11.387.599.11.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.91 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.303 24 12 24 5.373 18.627 0 12 0z"/>
                            </svg>
                        </a>
                    </div>
                </div>
                <div class="w-full md:w-64 flex flex-col border-r flex-1 min-h-0" style="border-color: var(--border-color); background-color: var(--bg-secondary);">
                    <div class="p-4 border-b font-bold truncate flex-shrink-0" id="guild-name" style="border-color: var(--border-color);"></div>
                    <div id="channel-list" class="flex-1 overflow-y-auto p-2"></div>
                    <div class="relative flex-shrink-0">
                        <div id="user-info-panel" class="p-2 border-t flex items-center gap-3 cursor-pointer hover:bg-gray-500/10" style="border-color: var(--border-color);"></div>
                        <div id="account-switcher" class="hidden absolute bottom-full left-0 w-full p-2 mb-2 rounded-lg shadow-2xl" style="background-color: var(--bg-tertiary);">
                            <div id="account-list" class="flex flex-col gap-1"></div>
                            <div id="add-account-switcher-btn" class="mt-2 text-center text-sm p-2 rounded-md cursor-pointer hover:bg-gray-500/20">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="chat-section" class="hidden flex-1 md:flex flex-col min-h-0 min-w-0">
                <div class="p-3 border-b flex items-center justify-between flex-shrink-0" style="border-color: var(--border-color); background-color:var(--bg-secondary);">
                    <div class="font-bold flex items-center truncate">
                        <button id="back-to-channels-btn" class="mr-3 p-1 rounded-full hover:bg-gray-500/20 md:hidden">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <span id="channel-name-text"></span>
                    </div>
                </div>
                <div id="message-container" class="flex-1 overflow-y-auto p-4 space-y-1" style="background-color: var(--bg-primary);"></div>
                <div class="flex-shrink-0">
                    <div id="slash-command-picker" class="hidden p-2 border-t" style="border-color:var(--border-color); background-color: var(--bg-quaternary);">
                        <b>Âà©Áî®ÂèØËÉΩ„Å™„Ç≥„Éû„É≥„Éâ:</b>
                        <div class="text-xs opacity-70">„Éï„Ç©„Éº„ÇØÂÖÉ„Å´„ÅÇ„Å£„Åü„Åã„ÇâÊÆã„Åó„Å¶„ÅÑ„Åæ„Åô„ÅåÂÆüË£Ö‰∫àÂÆö„ÅØ„Å™„ÅÑ„Åß„Åô„ÄÇ</div>
                    </div>
                    <div id="attachment-preview-bar" class="hidden p-2 text-sm border-t items-center justify-between" style="border-color: var(--border-color); background-color: var(--bg-quaternary);">
                        <div>
                            Attaching: <b id="attachment-preview-name"></b>
                        </div>
                        <button id="cancel-attachment-btn" class="p-1 rounded-full hover:bg-gray-500/30">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-4 border-t flex items-end gap-2" style="border-color: var(--border-color); background-color:var(--bg-secondary);">
                        <input type="file" id="file-input" class="hidden" multiple>
                        <button id="attach-button" class="p-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 flex-shrink-0" title="„Éï„Ç°„Ç§„É´„ÇíÊ∑ª‰ªò">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v11.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"></path>
                            </svg>
                        </button>
                        <div class="relative w-full">
                            <div id="reply-bar" class="hidden absolute bottom-full left-0 w-full text-sm p-2 bg-[var(--bg-quaternary)] rounded-t-md">
                                Replying to <b id="reply-username"></b>
                                <button id="cancel-reply-btn" class="absolute right-2 top-2 p-1 rounded-full hover:bg-gray-500/30">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                            <textarea id="message-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°" class="input-field w-full p-3 rounded-md resize-none pr-16" rows="1"></textarea>
                            <div id="char-counter" class="absolute bottom-2 right-2 text-xs text-gray-500"></div>
                        </div>
                        <button id="send-button" class="p-3 rounded-md font-bold text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50" disabled>
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                <div class="bg-[var(--bg-secondary)] dark:bg-gray-700 rounded-lg shadow-2xl w-full max-w-sm" style="border-color: var(--border-color);">
                    <div id="profile-modal-header" class="h-20 rounded-t-lg relative" style="background-color: var(--button-bg);">
                        <button onclick="closeProfileModal()" class="absolute top-2 right-2 p-1 rounded-full text-white hover:bg-black/20">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div class="p-4 pt-0">
                        <div class="flex relative -mt-12 mb-4">
                            <img id="profile-avatar" class="w-24 h-24 rounded-full border-4" style="border-color: var(--bg-secondary);">
                            <div id="profile-status-dot" class="status-dot w-5 h-5" style="bottom: 4px; right: 4px; border-width: 4px;"></div>
                        </div>
                        <h2 id="profile-name" class="text-xl font-bold truncate"></h2>
                        <div id="profile-username" class="text-sm opacity-60 mb-4"></div>
                        <div id="profile-details">
                            <div class="mb-3">
                                <b class="block text-xs uppercase opacity-70">„É°„É≥„Éê„Éº„Ç∑„ÉÉ„Éó</b>
                                <span id="profile-member-since" class="text-sm"></span>
                            </div>
                        </div>
                        <button id="block-user-btn" class="w-full bg-red-600 hover:bg-red-700 py-2 mt-4 rounded-md font-bold text-white"></button>
                    </div>
                </div>
            </div>

            <div id="status-picker" class="hidden absolute bottom-20 left-2 w-48 p-2 rounded-lg shadow-2xl z-20" style="background-color: var(--bg-tertiary);">
                <div class="text-xs font-bold uppercase opacity-70 mb-1">„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíË®≠ÂÆö</div>
                <div id="status-online" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('online')">
                    <div class="status-dot online"></div><span class="ml-4">„Ç™„É≥„É©„Ç§„É≥</span>
                </div>
                <div id="status-idle" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('idle')">
                    <div class="status-dot idle"></div><span class="ml-4">ÈÄÄÂ∏≠‰∏≠</span>
                </div>
                <div id="status-dnd" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('dnd')">
                    <div class="status-dot dnd"></div><span class="ml-4">Âèñ„ÇäËæº„Åø‰∏≠</span>
                </div>
                <div id="status-offline" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('invisible')">
                    <div class="status-dot offline"></div><span class="ml-4">„Ç™„Éï„É©„Ç§„É≥</span>
                </div>
            </div>
        </div>
<script>
const BASE_URL = 'https://discord-api-proxy.zuotengyangyin0.workers.dev';
const API_BASE = BASE_URL; 
const CDN_BASE = BASE_URL;

let currentAccount = null;
let currentChannel = null;
let replyingTo = null;
let oldestMessageId = null;
let isLoadingMore = false;
let attachedFiles = [];
let maxCharCount = 2000;
let guildFolders = [];
let guildDataMap = new Map();
let openFolderId = null;
let pingCounts = {};
let messageStore = {};
let editedMessages = {};
let pollingInterval = null;

const plugins = JSON.parse(localStorage.getItem('plugins')) || {
    showMeYourName: false,
    sendSeconds: false,
    messageLogger: true,
    clickAction: true,
    showCharacter: true
};

document.addEventListener('DOMContentLoaded', async () => {
    if (localStorage.theme === 'dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }

    const setClick = (id, fn) => { const el = document.getElementById(id); if(el) el.onclick = fn; };

    setClick('add-account-button', () => addAccount(document.getElementById('token-input').value));
    setClick('cancel-add-account-button', () => { if(getAccounts().length > 0) updateView('app'); });
    setClick('dm-icon', loadDms);
    setClick('theme-toggle-btn', toggleTheme);
    setClick('add-account-switcher-btn', showLoginScreen);
    setClick('send-button', sendMessage);
    setClick('attach-button', () => document.getElementById('file-input').click());
    setClick('cancel-attachment-btn', () => { attachedFiles = []; renderAttachmentList(); });
    setClick('cancel-reply-btn', cancelReply);
    setClick('back-to-channels-btn', showSidebarView);

    const fileInput = document.getElementById('file-input');
    if(fileInput) fileInput.onchange = (e) => { if (e.target.files.length > 0) handleFiles(e.target.files); };

    const input = document.getElementById('message-input');
    if(input) {
        input.oninput = handleInput;
        input.onkeypress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };
        input.onkeydown = (e) => {
            if (e.key === 'ArrowUp' && input.value === '') {
                e.preventDefault();
                const els = Array.from(document.querySelectorAll('.message-group')).reverse();
                for (let el of els) {
                    if (el.dataset.authorId === currentAccount.id && !el.classList.contains('message-failed')) {
                        startEdit(el.id.replace('message-', ''));
                        break;
                    }
                }
            }
        };
    }

    const userInfoPanel = document.getElementById('user-info-panel');
    if(userInfoPanel) userInfoPanel.onclick = (e) => {
        e.stopPropagation();
        document.getElementById('account-switcher')?.classList.toggle('hidden');
    };

    window.addEventListener('click', () => {
        document.getElementById('account-switcher')?.classList.add('hidden');
        document.getElementById('status-picker')?.classList.add('hidden');
    });

    document.getElementById('message-container')?.addEventListener('scroll', loadMoreMessages);

    const accounts = getAccounts();
    const activeId = getActiveAccountId();
    if (accounts.length > 0 && activeId) {
        switchAccount(activeId);
    } else {
        showLoginScreen();
    }
});

const getAccounts = () => JSON.parse(localStorage.getItem('accounts')) || [];
const saveAccounts = a => localStorage.setItem('accounts', JSON.stringify(a));
const getActiveAccountId = () => localStorage.getItem('activeAccountId');
const setActiveAccountId = id => localStorage.setItem('activeAccountId', id);

function toggleTheme() {
    if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.theme = 'light';
    } else {
        document.documentElement.classList.add('dark');
        localStorage.theme = 'dark';
    }
}

function generateNonce() {
    return (BigInt(Date.now() - 1420070400000) * 4194304n).toString();
}

async function apiRequest(token, path, method = 'GET', body = null, isFormData = false) {
    const opts = {
        method,
        headers: {
            'Authorization': token,
            'X-Super-Properties': btoa(JSON.stringify({ os: "Windows", browser: "Chrome", device: "", system_locale: "ja", client_build_number: 262355 }))
        }
    };
    if (body) {
        if (isFormData) {
            opts.body = body;
        } else {
            opts.body = JSON.stringify(body);
            opts.headers['Content-Type'] = 'application/json';
        }
    }
    try {
        const r = await fetch(`${API_BASE}${path}`, opts);
        if (r.status === 401) return { error: { message: "Unauthorized" }, status: 401 };
        const data = r.status === 204 ? {} : await r.json();
        if (!r.ok) return { error: data, status: r.status };
        return { data, status: r.status };
    } catch (e) {
        return { error: { message: "Network error" }, status: 0 };
    }
}

async function addAccount(token) {
    const spinner = document.getElementById('login-spinner');
    const errEl = document.getElementById('login-error');
    const btnText = document.getElementById('add-account-button-text');
    
    token = token.trim().replace(/^"|"$/g, '');
    if (!token) return;

    if(spinner) spinner.classList.remove('hidden');
    if(btnText) btnText.innerText = "";
    if(errEl) errEl.innerText = "";

    const result = await apiRequest(token, '/users/@me');
    
    if(spinner) spinner.classList.add('hidden');
    if(btnText) btnText.innerText = "„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†";

    if (result.data && result.data.id) {
        let a = getAccounts();
        const existing = a.findIndex(acc => acc.id === result.data.id);
        const newAcc = { ...result.data, token };
        if (existing > -1) a[existing] = newAcc;
        else a.push(newAcc);
        saveAccounts(a);
        switchAccount(result.data.id);
    } else {
        if(errEl) errEl.innerText = `„Ç®„É©„Éº: ${result.error?.message || 'ÁÑ°Âäπ„Å™„Éà„Éº„ÇØ„É≥'}`;
    }
}

function switchAccount(id) {
    cleanupState();
    setActiveAccountId(id);
    const accounts = getAccounts();
    const account = accounts.find(a => a.id === id);
    if (!account) { showLoginScreen(); return; }
    currentAccount = account;
    maxCharCount = (currentAccount.premium_type === 2) ? 4000 : 2000;
    renderCurrentUserPanel();
    updateView('app');
    loadGuilds();
}

function renderCurrentUserPanel() {
    if (!currentAccount) return;
    const panel = document.getElementById('user-info-panel');
    if(!panel) return;

    const name = currentAccount.global_name || currentAccount.username;
    const username = currentAccount.username;
    const avatar = currentAccount.avatar 
        ? `${CDN_BASE}/avatars/${currentAccount.id}/${currentAccount.avatar}.png?size=64` 
        : `${CDN_BASE}/embed/avatars/${currentAccount.discriminator % 5}.png`;
    
    panel.innerHTML = `
        <img src="${avatar}" class="w-8 h-8 rounded-full bg-gray-300 object-cover">
        <div class="flex-1 min-w-0">
            <div class="font-bold text-sm truncate">${name}</div>
            <div class="text-xs text-[var(--text-secondary)] truncate">@${username}</div>
        </div>
    `;
    const modalAvatar = document.getElementById('profile-avatar');
    if(modalAvatar) modalAvatar.src = avatar;
    renderAccountSwitcher();
}

function renderAccountSwitcher() {
    const list = document.getElementById('account-list');
    if(!list) return;
    const accounts = getAccounts();
    const activeId = getActiveAccountId();
    list.innerHTML = accounts.map(acc => {
        const av = acc.avatar 
            ? `${CDN_BASE}/avatars/${acc.id}/${acc.avatar}.png?size=64` 
            : `${CDN_BASE}/embed/avatars/${acc.discriminator % 5}.png`;
        const isActive = acc.id === activeId;
        return `
        <div class="flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="switchAccount('${acc.id}')">
            <img src="${av}" class="w-8 h-8 rounded-full object-cover">
            <div class="flex-1 min-w-0">
                <div class="font-bold text-sm truncate">${acc.global_name || acc.username}</div>
            </div>
            ${isActive ? '<div class="w-2 h-2 bg-green-500 rounded-full"></div>' : ''}
        </div>`;
    }).join('');
}

function updateView(viewName) {
    const auth = document.getElementById('auth-section');
    const app = document.getElementById('main-app');
    if (viewName === 'auth') {
        auth.classList.remove('hidden');
        auth.classList.add('flex');
        app.classList.add('hidden');
        app.classList.remove('flex');
        const hasAcc = getAccounts().length > 0;
        const cancelBtn = document.getElementById('cancel-add-account-button');
        if(cancelBtn) {
            if(hasAcc) cancelBtn.classList.remove('hidden');
            else cancelBtn.classList.add('hidden');
        }
    } else {
        auth.classList.add('hidden');
        auth.classList.remove('flex');
        app.classList.remove('hidden');
        app.classList.add('flex');
        if (window.innerWidth < 768) showSidebarView();
    }
}

function showLoginScreen() {
    updateView('auth');
    const tokenInput = document.getElementById('token-input');
    if(tokenInput) tokenInput.value = '';
    const errEl = document.getElementById('login-error');
    if(errEl) errEl.innerText = '';
}

function cleanupState() {
    if (pollingInterval) clearInterval(pollingInterval);
    currentChannel = null;
    attachedFiles = [];
    messageStore = {};
    editedMessages = {};
    guildDataMap.clear();
    const gList = document.getElementById('guild-list');
    if(gList) gList.innerHTML = '';
    const cList = document.getElementById('channel-list');
    if(cList) cList.innerHTML = '';
    const mCont = document.getElementById('message-container');
    if(mCont) mCont.innerHTML = '';
    const gName = document.getElementById('guild-name');
    if(gName) gName.innerText = '';
    renderAttachmentList();
    cancelReply();
}

async function loadGuilds() {
    if (!currentAccount) return;
    const res = await apiRequest(currentAccount.token, '/users/@me/guilds');
    if (res.error) return;
    const list = document.getElementById('guild-list');
    if(!list) return;
    list.innerHTML = '';
    guildDataMap.clear();
    res.data.forEach(g => {
        guildDataMap.set(g.id, g);
        list.appendChild(createGuildIcon(g));
    });
}

function createGuildIcon(g) {
    const div = document.createElement('div');
    div.className = 'server-icon bg-gray-700 hover:bg-indigo-500 text-white flex items-center justify-center transition-all mb-2';
    div.title = g.name;
    div.id = `guild-${g.id}`;
    if (g.icon) {
        div.innerHTML = `<img src="${CDN_BASE}/icons/${g.id}/${g.icon}.png?size=128" class="w-full h-full object-cover">`;
    } else {
        div.innerText = g.name.substring(0, 2);
    }
    div.onclick = () => loadChannels(g, div);
    return div;
}

async function loadDms() {
    document.querySelectorAll('.server-icon.active').forEach(e => e.classList.remove('active'));
    document.getElementById('dm-icon')?.classList.add('active');
    const gName = document.getElementById('guild-name');
    if(gName) gName.innerText = '„ÉÄ„Ç§„É¨„ÇØ„Éà„É°„ÉÉ„Çª„Éº„Ç∏';
    
    const res = await apiRequest(currentAccount.token, '/users/@me/channels');
    if (res.error) return;
    const list = document.getElementById('channel-list');
    if(!list) return;
    list.innerHTML = '';
    const dms = res.data.sort((a,b) => (b.last_message_id||0) - (a.last_message_id||0));
    dms.forEach(dm => {
        const div = document.createElement('div');
        div.className = 'channel-item p-2 rounded cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2 mb-1';
        let name = "DM";
        let iconHtml = '<span class="text-gray-500">@</span>';
        if (dm.recipients && dm.recipients.length > 0) {
            const user = dm.recipients[0];
            name = user.global_name || user.username;
            const av = user.avatar ? `${CDN_BASE}/avatars/${user.id}/${user.avatar}.png?size=32` : `${CDN_BASE}/embed/avatars/0.png`;
            iconHtml = `<img src="${av}" class="w-6 h-6 rounded-full">`;
        }
        div.innerHTML = `${iconHtml}<span class="truncate text-sm font-medium">${name}</span>`;
        div.onclick = () => selectChannel(dm);
        list.appendChild(div);
    });
}

async function loadChannels(guild, element) {
    document.querySelectorAll('.server-icon.active').forEach(e => e.classList.remove('active'));
    if (element) element.classList.add('active');
    document.getElementById('guild-name').innerText = guild.name;
    
    const res = await apiRequest(currentAccount.token, `/guilds/${guild.id}/channels`);
    if (res.error) return;
    
    const list = document.getElementById('channel-list');
    if(!list) return;
    list.innerHTML = '';
    const channels = res.data;
    const categories = channels.filter(c => c.type === 4).sort((a,b) => a.position - b.position);
    const textChannels = channels.filter(c => c.type === 0 || c.type === 5).sort((a,b) => a.position - b.position);
    
    textChannels.filter(c => !c.parent_id).forEach(c => list.appendChild(createChannelItem(c)));
    categories.forEach(cat => {
        const catDiv = document.createElement('div');
        catDiv.className = 'mt-4 mb-1 px-1 text-xs font-bold text-gray-500 uppercase flex items-center cursor-pointer hover:text-gray-300';
        catDiv.innerHTML = `<svg class="w-3 h-3 mr-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>${cat.name}`;
        const childContainer = document.createElement('div');
        const children = textChannels.filter(c => c.parent_id === cat.id);
        children.forEach(c => childContainer.appendChild(createChannelItem(c)));
        catDiv.onclick = () => {
            childContainer.classList.toggle('hidden');
            catDiv.querySelector('svg').classList.toggle('-rotate-90');
        };
        if (children.length > 0) {
            list.appendChild(catDiv);
            list.appendChild(childContainer);
        }
    });
}

function createChannelItem(c) {
    const div = document.createElement('div');
    div.className = 'channel-item p-2 rounded cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-1 mb-0.5 ml-2';
    div.id = `channel-${c.id}`;
    const icon = c.type === 5 
        ? '<svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>'
        : '<span class="text-gray-400 text-lg">#</span>';
    div.innerHTML = `${icon}<span class="truncate text-sm font-medium text-gray-700 dark:text-gray-300">${c.name}</span>`;
    div.onclick = () => selectChannel(c);
    return div;
}

// „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„É≠„Ç∏„ÉÉ„ÇØ
async function sendMessage() {
    if (!currentChannel) return;
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    
    if (!content && attachedFiles.length === 0) return;
    
    input.value = '';
    const filesToSend = [...attachedFiles];
    attachedFiles = [];
    renderAttachmentList();
    const currentReply = replyingTo;
    cancelReply();

    const payload = {
        content: content,
        tts: false,
        nonce: generateNonce(),
        flags: 0
    };
    
    if (currentReply) {
        payload.message_reference = { message_id: currentReply.messageId, fail_if_not_exists: false };
    }

    let res;
    if (filesToSend.length === 0) {
        // „ÉÜ„Ç≠„Çπ„Éà„ÅÆ„ÅøÔºöapplication/json
        res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages`, 'POST', payload);
    } else {
        // „Éï„Ç°„Ç§„É´„ÅÇ„ÇäÔºömultipart/form-data
        const body = new FormData();
        body.append('payload_json', JSON.stringify(payload));
        filesToSend.forEach((f, i) => body.append(`files[${i}]`, f));
        res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages`, 'POST', body, true);
    }
    
    if (res.error) {
        alert('ÈÄÅ‰ø°„Ç®„É©„Éº: ' + (res.error.message || JSON.stringify(res.error)));
        input.value = content;
    } else {
        setTimeout(startPolling, 200);
    }
}

async function selectChannel(channel) {
    if (pollingInterval) clearInterval(pollingInterval);
    currentChannel = channel;
    oldestMessageId = null;
    isLoadingMore = false;
    cancelReply();
    attachedFiles = [];
    renderAttachmentList();
    document.querySelectorAll('.channel-item').forEach(e => e.classList.remove('bg-gray-300', 'dark:bg-gray-600'));
    const el = document.getElementById(`channel-${channel.id}`);
    if (el) el.classList.add('bg-gray-300', 'dark:bg-gray-600');
    if (window.innerWidth < 768) showChatView();
    
    let name = channel.name;
    if (!name && channel.recipients) name = channel.recipients[0].global_name || channel.recipients[0].username;
    document.getElementById('channel-name-text').innerHTML = `<span class="text-gray-400 mr-1">#</span>${name || 'DM'}`;
    
    const container = document.getElementById('message-container');
    if(!container) return;
    container.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader border-t-blue-500 rounded-full border-4 border-gray-200 h-8 w-8"></div></div>';
    
    const res = await apiRequest(currentAccount.token, `/channels/${channel.id}/messages?limit=50`);
    container.innerHTML = '';
    if (res.error) {
        container.innerHTML = `<div class="text-center text-red-500 mt-10">„Ç®„É©„Éº<br>${res.error.message}</div>`;
        return;
    }
    if (res.data.length > 0) {
        oldestMessageId = res.data[res.data.length - 1].id;
        const fragment = document.createDocumentFragment();
        [...res.data].reverse().forEach((m, i, arr) => {
            const prev = i > 0 ? arr[i-1] : null;
            const isGrouped = prev && prev.author.id === m.author.id && !m.referenced_message && (new Date(m.timestamp) - new Date(prev.timestamp) < 5 * 60 * 1000);
            fragment.appendChild(createMessageElement(m, isGrouped));
        });
        container.appendChild(fragment);
        container.scrollTop = container.scrollHeight;
    }
    startPolling();
}

function startPolling() {
    pollingInterval = setInterval(async () => {
        if (!currentChannel) return;
        const container = document.getElementById('message-container');
        if(!container) return;
        const lastMsg = container.lastElementChild;
        let afterId = lastMsg ? lastMsg.id.replace('message-', '') : null;
        if (!afterId && oldestMessageId) afterId = oldestMessageId; 
        if (!afterId) return;
        const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages?after=${afterId}`);
        if (res.data && res.data.length > 0) {
            const wasBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
            [...res.data].reverse().forEach(m => {
                if (document.getElementById(`message-${m.id}`)) return;
                const last = container.lastElementChild;
                const isGrouped = last && last.dataset.authorId === m.author.id && !m.referenced_message;
                container.appendChild(createMessageElement(m, isGrouped));
            });
            if (wasBottom) container.scrollTop = container.scrollHeight;
        }
    }, 1000);
}

async function loadMoreMessages() {
    if (isLoadingMore || !oldestMessageId || !currentChannel) return;
    const container = document.getElementById('message-container');
    if (container.scrollTop > 50) return;
    isLoadingMore = true;
    const beforeScroll = container.scrollHeight;
    const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages?before=${oldestMessageId}&limit=50`);
    if (res.data && res.data.length > 0) {
        oldestMessageId = res.data[res.data.length - 1].id;
        const fragment = document.createDocumentFragment();
        [...res.data].reverse().forEach((m) => fragment.appendChild(createMessageElement(m, false)));
        container.prepend(fragment);
        container.scrollTop = container.scrollHeight - beforeScroll;
    }
    isLoadingMore = false;
}

function createMessageElement(m, isGrouped) {
    const el = document.createElement('div');
    el.id = `message-${m.id}`;
    el.dataset.authorId = m.author.id;
    el.className = `message-group flex flex-col px-4 py-0.5 hover:bg-gray-100 dark:hover:bg-gray-700/50 relative group ${isGrouped ? 'mt-0' : 'mt-4'}`;
    if (m.mentions && m.mentions.some(u => u.id === currentAccount.id)) {
        el.classList.add('bg-yellow-500/10', 'hover:bg-yellow-500/20');
        el.style.borderLeft = "2px solid #faa61a";
    }
    const toolbar = document.createElement('div');
    toolbar.className = 'message-toolbar absolute -top-4 right-4 bg-white dark:bg-gray-800 shadow rounded border border-gray-200 dark:border-gray-700 p-1 hidden group-hover:flex gap-1 z-10';
    const btnClass = "p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500 dark:text-gray-400";
    toolbar.innerHTML = `
        <button class="${btnClass}" onclick="startReply(${JSON.stringify({id:m.id, author:m.author}).replace(/"/g, '&quot;')})">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/></svg>
        </button>
    `;
    if (m.author.id === currentAccount.id) {
        toolbar.innerHTML += `
            <button class="${btnClass}" onclick="startEdit('${m.id}')">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </button>
            <button class="${btnClass} text-red-500 hover:text-red-600" onclick="deleteMessage('${m.id}')">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>
        `;
    }
    el.appendChild(toolbar);
    if (m.referenced_message && !isGrouped) {
        const ref = m.referenced_message;
        const refName = ref.author ? (ref.author.global_name || ref.author.username) : "Unknown";
        const refDiv = document.createElement('div');
        refDiv.className = 'flex items-center gap-1 text-xs text-gray-500 mb-1 ml-4 cursor-pointer opacity-70 hover:opacity-100';
        refDiv.onclick = () => document.getElementById(`message-${ref.id}`)?.scrollIntoView({block:'center', behavior:'smooth'});
        refDiv.innerHTML = `<div class="w-6 border-t-2 border-l-2 border-gray-400 h-2 rounded-tl-md mr-1"></div>
            <img src="${ref.author?.avatar ? `${CDN_BASE}/avatars/${ref.author.id}/${ref.author.avatar}.png?size=16` : ''}" class="w-4 h-4 rounded-full">
            <span class="font-bold">@${refName}</span>
            <span class="truncate max-w-xs">${ref.content || 'Click to see attachment'}</span>`;
        el.appendChild(refDiv);
    }
    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'flex';
    if (!isGrouped) {
        const avUrl = m.author.avatar 
            ? `${CDN_BASE}/avatars/${m.author.id}/${m.author.avatar}.png?size=64`
            : `${CDN_BASE}/embed/avatars/${m.author.discriminator % 5}.png`;
        contentWrapper.innerHTML = `
            <div class="flex-shrink-0 mr-4 mt-0.5 cursor-pointer" onclick="openProfileModal('${m.author.id}')">
                <img src="${avUrl}" class="w-10 h-10 rounded-full hover:drop-shadow-md transition object-cover">
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-0.5">
                    <span class="font-medium text-gray-900 dark:text-gray-100 hover:underline cursor-pointer">${m.author.global_name || m.author.username}</span>
                    <span class="text-xs text-gray-500">${new Date(m.timestamp).toLocaleString()}</span>
                </div>
                <div class="message-body text-gray-800 dark:text-gray-300 whitespace-pre-wrap leading-relaxed break-words">${parseMarkdown(m.content)}</div>
                ${renderAttachments(m.attachments)}
                ${renderEmbeds(m.embeds)}
                ${renderComponents(m.components)}
            </div>
        `;
    } else {
        const timeStr = new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        contentWrapper.innerHTML = `
            <div class="w-14 text-[10px] text-gray-400 text-right pr-4 opacity-0 group-hover:opacity-100 select-none pt-1">${timeStr}</div>
            <div class="flex-1 min-w-0">
                 <div class="message-body text-gray-800 dark:text-gray-300 whitespace-pre-wrap leading-relaxed break-words">${parseMarkdown(m.content)}</div>
                 ${renderAttachments(m.attachments)}
                 ${renderEmbeds(m.embeds)}
                 ${renderComponents(m.components)}
            </div>
        `;
    }
    const bodyEl = contentWrapper.querySelector('.message-body');
    if(bodyEl) bodyEl.dataset.original = m.content;
    el.appendChild(contentWrapper);
    return el;
}

// ‰øÆÊ≠£Ôºö„Éú„Çø„É≥ÔºàComponentsÔºâ„É¨„É≥„ÉÄ„É™„É≥„Ç∞ËøΩÂä†
function renderComponents(components) {
    if (!components || components.length === 0) return '';
    
    return components.map(row => {
        if (row.type !== 1) return ''; // Action Row„ÅÆ„Åø
        
        const btns = row.components.map(c => {
            if (c.type !== 2) return ''; // „Éú„Çø„É≥„ÅÆ„ÅøÂØæÂøú
            
            // „Çπ„Çø„Ç§„É´ÂÆöÁæ©
            let bgClass = "bg-[#4f545c] hover:bg-[#393c43]"; // Default/Secondary/Link
            if (c.style === 1) bgClass = "bg-[#5865F2] hover:bg-[#4752C4]"; // Primary
            else if (c.style === 3) bgClass = "bg-[#2d7d46] hover:bg-[#215b32]"; // Success
            else if (c.style === 4) bgClass = "bg-[#ed4245] hover:bg-[#c03537]"; // Danger
            
            let emoji = '';
            if (c.emoji) {
                if (c.emoji.id) {
                    emoji = `<img src="${CDN_BASE}/emojis/${c.emoji.id}.png" class="w-4 h-4 object-contain">`;
                } else {
                    emoji = `<span class="text-sm">${c.emoji.name}</span>`;
                }
            }
            
            const label = c.label ? `<span class="font-medium">${c.label}</span>` : '';
            const content = `<div class="flex items-center gap-1.5">${emoji}${label}</div>`;
            
            if (c.style === 5 && c.url) {
                // „É™„É≥„ÇØ„Éú„Çø„É≥Ôºà„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩÔºâ
                return `<a href="${c.url}" target="_blank" class="${bgClass} text-white px-4 py-2 rounded-[3px] text-sm transition-colors inline-block no-underline h-8 box-border flex items-center">${content}</a>`;
            } else {
                // „Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ÔºàLiteÁâà„Åß„ÅØÁÑ°ÂäπÂåñÔºâ
                return `<button disabled class="${bgClass} text-white px-4 py-2 rounded-[3px] text-sm transition-colors opacity-50 cursor-not-allowed h-8 box-border">${content}</button>`;
            }
        }).join('');
        
        return `<div class="flex flex-wrap gap-2 mt-2">${btns}</div>`;
    }).join('');
}

function renderEmbeds(embeds) {
    if (!embeds || embeds.length === 0) return '';
    
    return embeds.map(embed => {
        const colorStyle = embed.color ? `border-left-color: #${embed.color.toString(16).padStart(6, '0')};` : 'border-left-color: #202225;';
        const proxyUrl = (url) => url ? url.replace(/^https?:\/\/(cdn\.discordapp\.com|media\.discordapp\.net)/, CDN_BASE) : '';

        let html = `<div class="mt-2 border-l-4 rounded bg-gray-50 dark:bg-[#2f3136] p-3 max-w-xl" style="${colorStyle}">`;

        if (embed.provider) {
            html += `<div class="text-xs text-gray-500 mb-1">${embed.provider.name}</div>`;
        }

        if (embed.author) {
            html += `<div class="flex items-center mb-1 gap-2">`;
            if (embed.author.icon_url) {
                html += `<img src="${proxyUrl(embed.author.icon_url)}" class="w-5 h-5 rounded-full">`;
            }
            html += `<span class="text-sm font-bold text-gray-700 dark:text-gray-300">${embed.author.name}</span></div>`;
        }

        if (embed.title) {
            if (embed.url) {
                html += `<a href="${embed.url}" target="_blank" class="block text-blue-500 font-bold hover:underline mb-1">${embed.title}</a>`;
            } else {
                html += `<div class="text-blue-500 font-bold mb-1">${embed.title}</div>`;
            }
        }

        if (embed.description) {
            html += `<div class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-wrap mb-2">${parseMarkdown(embed.description)}</div>`;
        }

        if (embed.fields && embed.fields.length > 0) {
            html += `<div class="grid grid-cols-12 gap-2 mb-2">`;
            embed.fields.forEach(field => {
                const colSpan = field.inline ? 'col-span-4' : 'col-span-12';
                html += `<div class="${colSpan}">
                    <div class="text-xs font-bold text-gray-500 mb-0.5">${field.name}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-300 whitespace-pre-wrap">${parseMarkdown(field.value)}</div>
                </div>`;
            });
            html += `</div>`;
        }

        if (embed.image) {
            html += `<a href="${embed.image.url}" target="_blank" class="block mt-2"><img src="${proxyUrl(embed.image.url)}" class="max-w-full rounded max-h-80"></a>`;
        }
        
        if (embed.thumbnail && !embed.image) {
             html += `<a href="${embed.thumbnail.url}" target="_blank" class="block mt-2"><img src="${proxyUrl(embed.thumbnail.url)}" class="max-w-[80px] rounded"></a>`;
        }

        if (embed.footer) {
            html += `<div class="flex items-center gap-2 mt-2 pt-2 border-t border-gray-200 dark:border-gray-700 text-xs text-gray-500">`;
            if (embed.footer.icon_url) {
                html += `<img src="${proxyUrl(embed.footer.icon_url)}" class="w-4 h-4 rounded-full">`;
            }
            html += `<span>${embed.footer.text}</span>`;
            if (embed.timestamp) {
                html += `<span class="before:content-['‚Ä¢'] before:mx-1">${new Date(embed.timestamp).toLocaleString()}</span>`;
            }
            html += `</div>`;
        } else if (embed.timestamp) {
             html += `<div class="text-xs text-gray-500 mt-2">${new Date(embed.timestamp).toLocaleString()}</div>`;
        }

        html += `</div>`;
        return html;
    }).join('');
}

function renderAttachments(atts) {
    if (!atts || atts.length === 0) return '';
    return atts.map(a => {
        const src = a.url.replace(/^https?:\/\/cdn\.discordapp\.com/, CDN_BASE);
        if (a.content_type && a.content_type.startsWith('image/')) {
            return `<a href="${src}" target="_blank" class="block mt-2"><img src="${src}" class="max-w-sm max-h-80 rounded-lg"></a>`;
        }
        return `<div class="mt-2"><a href="${src}" target="_blank" class="text-blue-500 hover:underline">üìé ${a.filename}</a></div>`;
    }).join('');
}

function parseMarkdown(text) {
    if (!text) return '';
    let html = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\n/g, "<br>")
        .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
        .replace(/\*(.*?)\*/g, '<i>$1</i>')
        .replace(/__(.*?)__/g, '<u>$1</u>')
        .replace(/~~(.*?)~~/g, '<s>$1</s>')
        .replace(/`(.*?)`/g, '<code class="bg-gray-200 dark:bg-gray-700 px-1 rounded font-mono text-sm">$1</code>');
    html = html.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 hover:underline">$1</a>');
    html = html.replace(/&lt;@!?(\d+)&gt;/g, '<span class="bg-indigo-500/20 text-indigo-500 px-1 rounded font-medium cursor-pointer">@$1</span>');
    return html;
}

function handleFiles(files) {
    for (const f of files) {
        if (attachedFiles.length < 5) attachedFiles.push(f);
    }
    renderAttachmentList();
}

function renderAttachmentList() {
    const previewBar = document.getElementById('attachment-preview-bar');
    const nameEl = document.getElementById('attachment-preview-name');
    if(previewBar && nameEl) {
        if (attachedFiles.length > 0) {
            previewBar.classList.remove('hidden');
            previewBar.classList.add('flex');
            nameEl.innerText = `${attachedFiles.length} file(s): ${attachedFiles.map(f=>f.name).join(', ')}`;
        } else {
            previewBar.classList.add('hidden');
            previewBar.classList.remove('flex');
        }
    }
}

function startEdit(msgId) {
    const el = document.getElementById(`message-${msgId}`);
    if(!el) return;
    const body = el.querySelector('.message-body');
    const original = body.dataset.original;
    body.innerHTML = `
        <div class="mt-1">
            <input type="text" class="w-full bg-gray-200 dark:bg-gray-600 p-2 rounded text-sm text-black dark:text-white" value="${original}" id="edit-input-${msgId}">
            <div class="text-xs text-gray-500 mt-1">Enter to save ‚Ä¢ Esc to cancel</div>
        </div>
    `;
    const input = document.getElementById(`edit-input-${msgId}`);
    input.focus();
    input.onkeydown = async (e) => {
        if (e.key === 'Enter') {
            await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages/${msgId}`, 'PATCH', {content: input.value});
            body.innerText = input.value; 
            body.dataset.original = input.value;
        } else if (e.key === 'Escape') {
            body.innerText = parseMarkdown(original); 
            body.innerHTML = parseMarkdown(original); 
        }
    };
}

async function deleteMessage(msgId) {
    if (!confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
    await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages/${msgId}`, 'DELETE');
    document.getElementById(`message-${msgId}`)?.remove();
}

function startReply(m) {
    replyingTo = { messageId: m.id };
    document.getElementById('reply-bar')?.classList.replace('hidden', 'flex');
    document.getElementById('reply-username').innerText = m.author.global_name || m.author.username;
    document.getElementById('message-input').focus();
}

function cancelReply() {
    replyingTo = null;
    document.getElementById('reply-bar')?.classList.replace('flex', 'hidden');
}

function handleInput() {
    const input = document.getElementById('message-input');
    const counter = document.getElementById('char-counter');
    const len = input.value.length;
    if(counter) {
        if (len > 0) {
            counter.classList.remove('opacity-0');
            counter.innerText = `${len}/${maxCharCount}`;
            counter.style.color = len > maxCharCount ? 'red' : '';
        } else {
            counter.classList.add('opacity-0');
        }
    }
    input.style.height = 'auto';
    input.style.height = input.scrollHeight + 'px';
}

function handleResize() {
    if (window.innerWidth >= 768) {
        showChatView();
        document.getElementById('sidebar-view')?.classList.remove('hidden');
    } else if (currentChannel) {
        showChatView();
    } else {
        showSidebarView();
    }
}

function showSidebarView() {
    document.getElementById('sidebar-view').classList.remove('hidden');
    document.getElementById('chat-section').classList.add('hidden');
}

function showChatView() {
    document.getElementById('sidebar-view').classList.add('hidden');
    document.getElementById('chat-section').classList.remove('hidden');
}

window.updateStatus = (status) => {
    alert(`Status set to ${status} (Visual only in Lite)`);
    document.getElementById('status-picker')?.classList.add('hidden');
    const dot = document.getElementById('profile-status-dot');
    if(dot) dot.className = `status-dot ${status === 'invisible' ? 'offline' : status}`;
};

window.closeProfileModal = () => {
    document.getElementById('profile-modal')?.classList.replace('flex', 'hidden');
};

window.openProfileModal = async (userId) => {
    const modal = document.getElementById('profile-modal');
    if(!modal) return;
    modal.classList.replace('hidden', 'flex');
    const res = await apiRequest(currentAccount.token, `/users/${userId}`);
    if(res.data) {
        const u = res.data;
        document.getElementById('profile-name').innerText = u.global_name || u.username;
        document.getElementById('profile-username').innerText = u.username;
        document.getElementById('profile-avatar').src = u.avatar ? `${CDN_BASE}/avatars/${u.id}/${u.avatar}.png?size=128` : `${CDN_BASE}/embed/avatars/${u.discriminator%5}.png`;
    }
};
</script>
    </body>
</html>
