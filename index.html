<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Discord Lite</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class'
            }
        </script>
<style>
    :root {
        --bg-primary: #f5f5f5;
        --bg-secondary: #ffffff;
        --bg-tertiary: #e0e0e0;
        --bg-quaternary: #ebebeb;
        --text-primary: #111111;
        --text-secondary: #555555;
        --text-link: #4f89e2;
        --border-color: #cccccc;
        --button-bg: #5865f2;
        --button-text: #fff;
        --hover-bg: #f0f0f0;
        --active-bg: #e0e0e0;
        --mention-bg: rgba(88, 101, 242, 0.1);
        --mention-fg: #5865f2;
        --system-bg: rgba(88, 166, 255, 0.1);
        --status-online: #3ba55d;
        --status-idle: #faa81a;
        --status-dnd: #ed4245;
        --status-offline: #747f8d;
    }

    html.dark {
        --bg-primary: #36393f;
        --bg-secondary: #2f3136;
        --bg-tertiary: #202225;
        --bg-quaternary: #292b2f;
        --text-primary: #e0e0e0;
        --text-secondary: #b9bbbe;
        --text-link: #58a6ff;
        --border-color: #40444b;
        --button-bg: #5865f2;
        --button-text: #ffffff;
        --hover-bg: #3a3c41;
        --active-bg: #40444b;
        --mention-bg: rgba(88, 101, 242, 0.15);
        --mention-fg: #7289da;
        --system-bg: rgba(88, 166, 255, 0.1);
    }

    html.dark .input-field {
        color: var(--text-primary);
    }

    .server-icon, .channel-item {
        position: relative;
    }

    .server-icon {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
    }
    
    .server-icon.active img, .server-icon.active div {
        border-radius: 0.5rem;
        transition: border-radius 0.5s ease-in-out;
    }


    .ping-dot {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 10px;
        height: 10px;
        background-color: #f84a4b;
        border-radius: 50%;
        border: 2px solid var(--bg-tertiary);
        z-index: 10;
    }

    .channel-item .ping-dot {
        bottom: 10px;
        right: 10px;
    }

    .channel-item.active {
        background-color: var(--active-bg);
    }

    .loader {
        border: 4px solid var(--bg-tertiary);
        border-top: 4px solid var(--button-bg);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--bg-tertiary);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .mention {
        color: var(--mention-fg);
        background-color: var(--mention-bg);
        padding: 0 2px;
        border-radius: 3px;
        font-weight: 500;
        cursor: pointer;
    }

    .message-group:hover .message-toolbar {
        visibility: visible;
        opacity: 1;
    }

    .message-toolbar {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.1s ease-in-out;
    }

    .status-dot {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 3px solid var(--bg-secondary);
        z-index: 5;
    }

    .status-dot.online { background-color: var(--status-online); }
    .status-dot.idle { background-color: var(--status-idle); }
    .status-dot.dnd { background-color: var(--status-dnd); }
    .status-dot.offline { background-color: var(--status-offline); }
</style>
    </head>
    <body class="font-sans h-screen flex flex-col overflow-hidden bg-gray-200 dark:bg-gray-800 text-[var(--text-primary)]">
        <div id="auth-section" class="w-full max-w-md m-auto p-8 rounded-lg shadow-xl flex-col bg-white dark:bg-gray-700 hidden">
            <h1 class="text-2xl font-bold text-center mb-2">アカウントを追加</h1>
            <div id="login-error" class="text-red-500 text-xs mb-3 text-center"></div>
            <form class="space-y-4" onsubmit="return false;">
                <input type="password" id="token-input" class="input-field w-full p-2.5 rounded-md" placeholder="Discord Token">
                <button type="button" id="add-account-button" class="bg-blue-600 hover:bg-blue-700 w-full py-3 rounded-md font-bold text-white flex justify-center items-center">
                    <span id="add-account-button-text">アカウントを追加</span>
                    <div id="login-spinner" class="loader hidden"></div>
                </button>
                <button type="button" id="cancel-add-account-button" class="bg-gray-600 hover:bg-gray-700 w-full py-2 rounded-md font-bold text-white">キャンセル</button>
            </form>
        </div>
        <div id="main-app" class="hidden flex-1 flex-row min-h-0 relative">
            <div id="sidebar-view" class="flex flex-row w-full h-full md:w-auto md:flex">
                <div class="p-2 flex flex-col items-center gap-2 overflow-y-auto flex-shrink-0" style="background-color: var(--bg-tertiary);">
                    <div id="dm-icon" title="DM" class="server-icon bg-indigo-600 flex items-center justify-center cursor-pointer text-white font-black text-xl mb-1">DM</div>
                    <div id="guild-list" class="flex flex-col items-center gap-2 w-full"></div>
                    <div class="mt-auto flex flex-col gap-2 pt-4">
                        <button id="theme-toggle-btn" class="server-icon bg-gray-500 hover:bg-gray-600 flex items-center justify-center text-white" title="テーマ切り替え"></button>
                        <a href="https://github.com/Bloxd-H/discord_lite" target="_blank" class="server-icon bg-gray-700 hover:bg-gray-800 text-white flex items-center justify-center" title="GitHub">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0C5.373 0 0 5.373 0 12c0 5.303 3.438 9.8 8.207 11.387.599.11.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.91 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.303 24 12 24 5.373 18.627 0 12 0z"/>
                            </svg>
                        </a>
                    </div>
                </div>
                <div class="w-full md:w-64 flex flex-col border-r flex-1 min-h-0" style="border-color: var(--border-color); background-color: var(--bg-secondary);">
                    <div class="p-4 border-b font-bold truncate flex-shrink-0" id="guild-name" style="border-color: var(--border-color);"></div>
                    <div id="channel-list" class="flex-1 overflow-y-auto p-2"></div>
                    <div class="relative flex-shrink-0">
                        <div id="user-info-panel" class="p-2 border-t flex items-center gap-3 cursor-pointer hover:bg-gray-500/10" style="border-color: var(--border-color);"></div>
                        <div id="account-switcher" class="hidden absolute bottom-full left-0 w-full p-2 mb-2 rounded-lg shadow-2xl" style="background-color: var(--bg-tertiary);">
                            <div id="account-list" class="flex flex-col gap-1"></div>
                            <div id="add-account-switcher-btn" class="mt-2 text-center text-sm p-2 rounded-md cursor-pointer hover:bg-gray-500/20">アカウントを追加</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="chat-section" class="hidden flex-1 md:flex flex-col min-h-0 min-w-0">
                <div class="p-3 border-b flex items-center justify-between flex-shrink-0" style="border-color: var(--border-color); background-color:var(--bg-secondary);">
                    <div class="font-bold flex items-center truncate">
                        <button id="back-to-channels-btn" class="mr-3 p-1 rounded-full hover:bg-gray-500/20 md:hidden">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <span id="channel-name-text"></span>
                    </div>
                </div>
                <div id="message-container" class="flex-1 overflow-y-auto p-4 space-y-1" style="background-color: var(--bg-primary);"></div>
                <div class="flex-shrink-0">
                    <div id="slash-command-picker" class="hidden p-2 border-t" style="border-color:var(--border-color); background-color: var(--bg-quaternary);">
                        <b>利用可能なコマンド:</b>
                        <div class="text-xs opacity-70">コマンド機能は現在開発中です。</div>
                    </div>
                    <div id="attachment-preview-bar" class="hidden p-2 text-sm border-t items-center justify-between" style="border-color: var(--border-color); background-color: var(--bg-quaternary);">
                        <div>
                            Attaching: <b id="attachment-preview-name"></b>
                        </div>
                        <button id="cancel-attachment-btn" class="p-1 rounded-full hover:bg-gray-500/30">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-4 border-t flex items-end gap-2" style="border-color: var(--border-color); background-color:var(--bg-secondary);">
                        <input type="file" id="file-input" class="hidden" multiple>
                        <button id="attach-button" class="p-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 flex-shrink-0" title="ファイルを添付">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v11.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"></path>
                            </svg>
                        </button>
                        <div class="relative w-full">
                            <div id="reply-bar" class="hidden absolute bottom-full left-0 w-full text-sm p-2 bg-[var(--bg-quaternary)] rounded-t-md">
                                Replying to <b id="reply-username"></b>
                                <button id="cancel-reply-btn" class="absolute right-2 top-2 p-1 rounded-full hover:bg-gray-500/30">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                            <textarea id="message-input" placeholder="メッセージを送信" class="input-field w-full p-3 rounded-md resize-none pr-16" rows="1"></textarea>
                            <div id="char-counter" class="absolute bottom-2 right-2 text-xs text-gray-500"></div>
                        </div>
                        <button id="send-button" class="p-3 rounded-md font-bold text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50" disabled>
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                <div class="bg-[var(--bg-secondary)] dark:bg-gray-700 rounded-lg shadow-2xl w-full max-w-sm" style="border-color: var(--border-color);">
                    <div id="profile-modal-header" class="h-20 rounded-t-lg relative" style="background-color: var(--button-bg);">
                        <button onclick="closeProfileModal()" class="absolute top-2 right-2 p-1 rounded-full text-white hover:bg-black/20">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div class="p-4 pt-0">
                        <div class="flex relative -mt-12 mb-4">
                            <img id="profile-avatar" class="w-24 h-24 rounded-full border-4" style="border-color: var(--bg-secondary);">
                            <div id="profile-status-dot" class="status-dot w-5 h-5" style="bottom: 4px; right: 4px; border-width: 4px;"></div>
                        </div>
                        <h2 id="profile-name" class="text-xl font-bold truncate"></h2>
                        <div id="profile-username" class="text-sm opacity-60 mb-4"></div>
                        <div id="profile-details">
                            <div class="mb-3">
                                <b class="block text-xs uppercase opacity-70">メンバーシップ</b>
                                <span id="profile-member-since" class="text-sm"></span>
                            </div>
                        </div>
                        <button id="block-user-btn" class="w-full bg-red-600 hover:bg-red-700 py-2 mt-4 rounded-md font-bold text-white"></button>
                    </div>
                </div>
            </div>

            <div id="status-picker" class="hidden absolute bottom-20 left-2 w-48 p-2 rounded-lg shadow-2xl z-20" style="background-color: var(--bg-tertiary);">
                <div class="text-xs font-bold uppercase opacity-70 mb-1">ステータスを設定</div>
                <div id="status-online" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('online')">
                    <div class="status-dot online"></div><span class="ml-4">オンライン</span>
                </div>
                <div id="status-idle" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('idle')">
                    <div class="status-dot idle"></div><span class="ml-4">退席中</span>
                </div>
                <div id="status-dnd" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('dnd')">
                    <div class="status-dot dnd"></div><span class="ml-4">取り込み中</span>
                </div>
                <div id="status-offline" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('invisible')">
                    <div class="status-dot offline"></div><span class="ml-4">オフライン</span>
                </div>
            </div>
        </div>
<script>
const API_BASE = 'https://yakisoba.cloudfree.jp/avoidcord';

/* ===== 状態 ===== */
let currentAccount = null;
let currentChannel = null;
let messagePollTimer = null;
let lastMessageId = null;

/* ===== ローカル保存 ===== */
const getAccounts = () => JSON.parse(localStorage.getItem('accounts')) || [];
const saveAccounts = a => localStorage.setItem('accounts', JSON.stringify(a));
const getActiveAccountId = () => localStorage.getItem('activeAccountId');
const setActiveAccountId = id => localStorage.setItem('activeAccountId', id);

/* ===== 共通 API ===== */
async function apiRequest(token, path, method = 'GET') {
    const res = await fetch(API_BASE + path, {
        method,
        headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
        }
    });

    if (!res.ok) {
        console.error('API error', res.status);
        return null;
    }
    return await res.json();
}

/* ===== アカウント追加 ===== */
async function addAccount(token) {
    token = token.trim().replace(/^"|"$/g, '');

    const me = await apiRequest(token, '/users/@me');
    if (!me || !me.id) {
        alert('トークン無効');
        return;
    }

    const accounts = getAccounts();
    const idx = accounts.findIndex(a => a.id === me.id);

    const acc = { ...me, token };
    if (idx >= 0) accounts[idx] = acc;
    else accounts.push(acc);

    saveAccounts(accounts);
    switchAccount(me.id);
}

/* ===== アカウント切替 ===== */
function switchAccount(id) {
    currentAccount = getAccounts().find(a => a.id === id);
    if (!currentAccount) return;

    setActiveAccountId(id);

    document.getElementById('main-app').classList.remove('hidden');
    document.getElementById('auth-section').classList.add('hidden');

    loadGuilds();
}

/* ===== ギルド ===== */
async function loadGuilds() {
    const guilds = await apiRequest(currentAccount.token, '/users/@me/guilds');
    if (!guilds) return;

    const list = document.getElementById('guild-list');
    list.innerHTML = '';

    guilds.forEach(g => {
        const el = document.createElement('div');
        el.className = 'server-icon cursor-pointer';
        el.innerText = g.name[0];
        el.onclick = () => loadChannels(g);
        list.appendChild(el);
    });
}

/* ===== チャンネル ===== */
async function loadChannels(guild) {
    document.getElementById('guild-name').innerText = guild.name;

    const channels = await apiRequest(
        currentAccount.token,
        `/guilds/${guild.id}/channels`
    );
    if (!channels) return;

    const list = document.getElementById('channel-list');
    list.innerHTML = '';

    channels
        .filter(c => c.type === 0)
        .sort((a, b) => a.position - b.position)
        .forEach(ch => {
            const el = document.createElement('div');
            el.className = 'channel-item p-2 cursor-pointer';
            el.innerText = `# ${ch.name}`;
            el.onclick = () => selectChannel(ch);
            list.appendChild(el);
        });
}

/* ===== チャンネル選択 ===== */
function selectChannel(channel) {
    currentChannel = channel;
    document.getElementById('channel-name-text').innerText = '# ' + channel.name;

    document.getElementById('message-container').innerHTML = '';
    lastMessageId = null;

    if (messagePollTimer) clearInterval(messagePollTimer);
    pollMessages();
    messagePollTimer = setInterval(pollMessages, 1000);
}

/* ===== メッセージ取得（RESTポーリング） ===== */
async function pollMessages() {
    if (!currentAccount || !currentChannel) return;

    const url = lastMessageId
        ? `/channels/${currentChannel.id}/messages?after=${lastMessageId}`
        : `/channels/${currentChannel.id}/messages?limit=30`;

    const messages = await apiRequest(currentAccount.token, url);
    if (!Array.isArray(messages)) return;

    for (const msg of messages.reverse()) {
        renderMessage(msg);
        lastMessageId = msg.id;
    }
}

/* ===== メッセージ描画 ===== */
function renderMessage(msg) {
    const box = document.getElementById('message-container');

    const el = document.createElement('div');
    el.className = 'mb-2';

    el.innerHTML = `
        <b>${msg.author.username}</b>
        <div class="text-sm">${escapeHtml(msg.content)}</div>
    `;
    box.appendChild(el);
    box.scrollTop = box.scrollHeight;
}

/* ===== util ===== */
function escapeHtml(str) {
    return str.replace(/[&<>"']/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;',
        '"':'&quot;',"'":'&#39;'
    }[s]));
}

/* ===== 初期化 ===== */
window.onload = () => {
    const id = getActiveAccountId();
    if (id) switchAccount(id);
    else {
        document.getElementById('auth-section').classList.remove('hidden');
    }
};
</script>

    </body>
</html>
