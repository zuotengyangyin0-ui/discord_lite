<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Discord Lite</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class'
            }
        </script>
<style>
    :root {
        --bg-primary: #f5f5f5;
        --bg-secondary: #ffffff;
        --bg-tertiary: #e0e0e0;
        --bg-quaternary: #ebebeb;
        --text-primary: #111111;
        --text-secondary: #555555;
        --text-link: #4f89e2;
        --border-color: #cccccc;
        --button-bg: #5865f2;
        --button-text: #fff;
        --hover-bg: #f0f0f0;
        --active-bg: #e0e0e0;
        --mention-bg: rgba(88, 101, 242, 0.1);
        --mention-fg: #5865f2;
        --system-bg: rgba(88, 166, 255, 0.1);
        --status-online: #3ba55d;
        --status-idle: #faa81a;
        --status-dnd: #ed4245;
        --status-offline: #747f8d;
    }

    html.dark {
        --bg-primary: #36393f;
        --bg-secondary: #2f3136;
        --bg-tertiary: #202225;
        --bg-quaternary: #292b2f;
        --text-primary: #e0e0e0;
        --text-secondary: #b9bbbe;
        --text-link: #58a6ff;
        --border-color: #40444b;
        --button-bg: #5865f2;
        --button-text: #ffffff;
        --hover-bg: #3a3c41;
        --active-bg: #40444b;
        --mention-bg: rgba(88, 101, 242, 0.15);
        --mention-fg: #7289da;
        --system-bg: rgba(88, 166, 255, 0.1);
    }

    html.dark .input-field {
        color: var(--text-primary);
    }

    .server-icon, .channel-item {
        position: relative;
    }

    .server-icon {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
    }
    
    .server-icon.active img, .server-icon.active div {
        border-radius: 0.5rem;
        transition: border-radius 0.5s ease-in-out;
    }


    .ping-dot {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 10px;
        height: 10px;
        background-color: #f84a4b;
        border-radius: 50%;
        border: 2px solid var(--bg-tertiary);
        z-index: 10;
    }

    .channel-item .ping-dot {
        bottom: 10px;
        right: 10px;
    }

    .channel-item.active {
        background-color: var(--active-bg);
    }

    .loader {
        border: 4px solid var(--bg-tertiary);
        border-top: 4px solid var(--button-bg);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--bg-tertiary);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .mention {
        color: var(--mention-fg);
        background-color: var(--mention-bg);
        padding: 0 2px;
        border-radius: 3px;
        font-weight: 500;
        cursor: pointer;
    }

    .message-group:hover .message-toolbar {
        visibility: visible;
        opacity: 1;
    }

    .message-toolbar {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.1s ease-in-out;
    }

    .status-dot {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 3px solid var(--bg-secondary);
        z-index: 5;
    }

    .status-dot.online { background-color: var(--status-online); }
    .status-dot.idle { background-color: var(--status-idle); }
    .status-dot.dnd { background-color: var(--status-dnd); }
    .status-dot.offline { background-color: var(--status-offline); }
</style>
    </head>
    <body class="font-sans h-screen flex flex-col overflow-hidden bg-gray-200 dark:bg-gray-800 text-[var(--text-primary)]">
        <div id="auth-section" class="w-full max-w-md m-auto p-8 rounded-lg shadow-xl flex-col bg-white dark:bg-gray-700 hidden">
            <h1 class="text-2xl font-bold text-center mb-2">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</h1>
            <div id="login-error" class="text-red-500 text-xs mb-3 text-center"></div>
            <form class="space-y-4" onsubmit="return false;">
                <input type="password" id="token-input" class="input-field w-full p-2.5 rounded-md" placeholder="Discord Token">
                <button type="button" id="add-account-button" class="bg-blue-600 hover:bg-blue-700 w-full py-3 rounded-md font-bold text-white flex justify-center items-center">
                    <span id="add-account-button-text">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</span>
                    <div id="login-spinner" class="loader hidden"></div>
                </button>
                <button type="button" id="cancel-add-account-button" class="bg-gray-600 hover:bg-gray-700 w-full py-2 rounded-md font-bold text-white">„Ç≠„É£„É≥„Çª„É´</button>
            </form>
        </div>
        <div id="main-app" class="hidden flex-1 flex-row min-h-0 relative">
            <div id="sidebar-view" class="flex flex-row w-full h-full md:w-auto md:flex">
                <div class="p-2 flex flex-col items-center gap-2 overflow-y-auto flex-shrink-0" style="background-color: var(--bg-tertiary);">
                    <div id="dm-icon" title="DM" class="server-icon bg-indigo-600 flex items-center justify-center cursor-pointer text-white font-black text-xl mb-1">DM</div>
                    <div id="guild-list" class="flex flex-col items-center gap-2 w-full"></div>
                    <div class="mt-auto flex flex-col gap-2 pt-4">
                        <button id="theme-toggle-btn" class="server-icon bg-gray-500 hover:bg-gray-600 flex items-center justify-center text-white" title="„ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà"></button>
                        <a href="https://github.com/Bloxd-H/discord_lite" target="_blank" class="server-icon bg-gray-700 hover:bg-gray-800 text-white flex items-center justify-center" title="GitHub">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0C5.373 0 0 5.373 0 12c0 5.303 3.438 9.8 8.207 11.387.599.11.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.91 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.303 24 12 24 5.373 18.627 0 12 0z"/>
                            </svg>
                        </a>
                    </div>
                </div>
                <div class="w-full md:w-64 flex flex-col border-r flex-1 min-h-0" style="border-color: var(--border-color); background-color: var(--bg-secondary);">
                    <div class="p-4 border-b font-bold truncate flex-shrink-0" id="guild-name" style="border-color: var(--border-color);"></div>
                    <div id="channel-list" class="flex-1 overflow-y-auto p-2"></div>
                    <div class="relative flex-shrink-0">
                        <div id="user-info-panel" class="p-2 border-t flex items-center gap-3 cursor-pointer hover:bg-gray-500/10" style="border-color: var(--border-color);"></div>
                        <div id="account-switcher" class="hidden absolute bottom-full left-0 w-full p-2 mb-2 rounded-lg shadow-2xl" style="background-color: var(--bg-tertiary);">
                            <div id="account-list" class="flex flex-col gap-1"></div>
                            <div id="add-account-switcher-btn" class="mt-2 text-center text-sm p-2 rounded-md cursor-pointer hover:bg-gray-500/20">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="chat-section" class="hidden flex-1 md:flex flex-col min-h-0 min-w-0">
                <div class="p-3 border-b flex items-center justify-between flex-shrink-0" style="border-color: var(--border-color); background-color:var(--bg-secondary);">
                    <div class="font-bold flex items-center truncate">
                        <button id="back-to-channels-btn" class="mr-3 p-1 rounded-full hover:bg-gray-500/20 md:hidden">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <span id="channel-name-text"></span>
                    </div>
                </div>
                <div id="message-container" class="flex-1 overflow-y-auto p-4 space-y-1" style="background-color: var(--bg-primary);"></div>
                <div class="flex-shrink-0">
                    <div id="slash-command-picker" class="hidden p-2 border-t" style="border-color:var(--border-color); background-color: var(--bg-quaternary);">
                        <b>Âà©Áî®ÂèØËÉΩ„Å™„Ç≥„Éû„É≥„Éâ:</b>
                        <div class="text-xs opacity-70">„Ç≥„Éû„É≥„ÉâÊ©üËÉΩ„ÅØÁèæÂú®ÈñãÁô∫‰∏≠„Åß„Åô„ÄÇ</div>
                    </div>
                    <div id="attachment-preview-bar" class="hidden p-2 text-sm border-t items-center justify-between" style="border-color: var(--border-color); background-color: var(--bg-quaternary);">
                        <div>
                            Attaching: <b id="attachment-preview-name"></b>
                        </div>
                        <button id="cancel-attachment-btn" class="p-1 rounded-full hover:bg-gray-500/30">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-4 border-t flex items-end gap-2" style="border-color: var(--border-color); background-color:var(--bg-secondary);">
                        <input type="file" id="file-input" class="hidden" multiple>
                        <button id="attach-button" class="p-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 flex-shrink-0" title="„Éï„Ç°„Ç§„É´„ÇíÊ∑ª‰ªò">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v11.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"></path>
                            </svg>
                        </button>
                        <div class="relative w-full">
                            <div id="reply-bar" class="hidden absolute bottom-full left-0 w-full text-sm p-2 bg-[var(--bg-quaternary)] rounded-t-md">
                                Replying to <b id="reply-username"></b>
                                <button id="cancel-reply-btn" class="absolute right-2 top-2 p-1 rounded-full hover:bg-gray-500/30">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                            <textarea id="message-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°" class="input-field w-full p-3 rounded-md resize-none pr-16" rows="1"></textarea>
                            <div id="char-counter" class="absolute bottom-2 right-2 text-xs text-gray-500"></div>
                        </div>
                        <button id="send-button" class="p-3 rounded-md font-bold text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50" disabled>
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                <div class="bg-[var(--bg-secondary)] dark:bg-gray-700 rounded-lg shadow-2xl w-full max-w-sm" style="border-color: var(--border-color);">
                    <div id="profile-modal-header" class="h-20 rounded-t-lg relative" style="background-color: var(--button-bg);">
                        <button onclick="closeProfileModal()" class="absolute top-2 right-2 p-1 rounded-full text-white hover:bg-black/20">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div class="p-4 pt-0">
                        <div class="flex relative -mt-12 mb-4">
                            <img id="profile-avatar" class="w-24 h-24 rounded-full border-4" style="border-color: var(--bg-secondary);">
                            <div id="profile-status-dot" class="status-dot w-5 h-5" style="bottom: 4px; right: 4px; border-width: 4px;"></div>
                        </div>
                        <h2 id="profile-name" class="text-xl font-bold truncate"></h2>
                        <div id="profile-username" class="text-sm opacity-60 mb-4"></div>
                        <div id="profile-details">
                            <div class="mb-3">
                                <b class="block text-xs uppercase opacity-70">„É°„É≥„Éê„Éº„Ç∑„ÉÉ„Éó</b>
                                <span id="profile-member-since" class="text-sm"></span>
                            </div>
                        </div>
                        <button id="block-user-btn" class="w-full bg-red-600 hover:bg-red-700 py-2 mt-4 rounded-md font-bold text-white"></button>
                    </div>
                </div>
            </div>

            <div id="status-picker" class="hidden absolute bottom-20 left-2 w-48 p-2 rounded-lg shadow-2xl z-20" style="background-color: var(--bg-tertiary);">
                <div class="text-xs font-bold uppercase opacity-70 mb-1">„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíË®≠ÂÆö</div>
                <div id="status-online" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('online')">
                    <div class="status-dot online"></div><span class="ml-4">„Ç™„É≥„É©„Ç§„É≥</span>
                </div>
                <div id="status-idle" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('idle')">
                    <div class="status-dot idle"></div><span class="ml-4">ÈÄÄÂ∏≠‰∏≠</span>
                </div>
                <div id="status-dnd" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('dnd')">
                    <div class="status-dot dnd"></div><span class="ml-4">Âèñ„ÇäËæº„Åø‰∏≠</span>
                </div>
                <div id="status-offline" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="updateStatus('invisible')">
                    <div class="status-dot offline"></div><span class="ml-4">„Ç™„Éï„É©„Ç§„É≥</span>
                </div>
            </div>
        </div>
<script>
    const API_BASE = 'https://yakisoba.cloudfree.jp/avoidcord';
    let ws, currentAccount, currentChannel, lastSequence, heartbeatInterval, timeoutInterval;
    let lastMessageInfo = {
        authorId: null,
        timestamp: null
    };
    let replyingTo = null;
    let oldestMessageId = null;
    let pingCounts = {};
    let isLoadingMore = false;
    let attachedFile = null;
    const sunIcon = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zM4.05 14.536l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 001.414 1.414zM1.5 10a1 1 0 011-1h1a1 1 0 110 2H2.5a1 1 0 01-1-1zm15 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1zM5.464 5.05a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0z"></path></svg>`;
    const moonIcon = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>`;

    const getAccounts = ()=>JSON.parse(localStorage.getItem('accounts')) || [];
    const saveAccounts = a=>localStorage.setItem('accounts', JSON.stringify(a));
    const getActiveAccountId = ()=>localStorage.getItem('activeAccountId');
    const setActiveAccountId = id=>localStorage.setItem('activeAccountId', id);
    const getBlockedUsers = ()=>JSON.parse(localStorage.getItem('blockedUsers') || '[]')
    const saveBlockedUsers = b=>localStorage.setItem('blockedUsers', JSON.stringify(b))
    const getStatus = ()=>localStorage.getItem('userStatus') || 'online';
    const setStatus = s=>localStorage.setItem('userStatus', s);

    function logger(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
    }

    const generateSuperProperties = ()=>btoa(JSON.stringify({
        os: "Windows",
        browser: "Chrome",
        device: "",
        system_locale: "ja",
        browser_user_agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        browser_version: "120.0.0.0",
        os_version: "10",
        release_channel: "stable",
        client_build_number: 262355
    }));
    function cleanupState() {
        if (ws) ws.close();
        ws = null;
        currentChannel = null;
        lastSequence = null;
        attachedFile = null;
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        if (timeoutInterval) clearInterval(timeoutInterval);
        document.getElementById('guild-list').innerHTML = '';
        document.getElementById('channel-list').innerHTML = '';
        document.getElementById('message-container').innerHTML = '';
        document.getElementById('guild-name').innerText = '';
        cancelReply();
        cancelAttachment();
        closeProfileModal();
        document.getElementById('status-picker').classList.add('hidden');
        logger('Cleanup complete and state reset.', 'info');
    }
    async function apiRequest(token, path, method='GET', body=null, isFormData=false) {
        const o = {
            method,
            headers: {
                'Authorization': token,
                'X-Super-Properties': generateSuperProperties()
            }
        };
        if (body) {
            if (isFormData) {
                o.body = body
            } else {
                o.body = JSON.stringify(body);
                o.headers['Content-Type'] = 'application/json';
            }
        }
        try {
            const r = await fetch(`${API_BASE}${path}`, o);
            const data = r.status === 204 ? {} : await r.json();
            if (!r.ok) {
                logger(`API Request Failed: ${method} ${path} - Status: ${r.status}, Error: ${data?.message || 'Unknown'}`, 'error');
                return {
                    error: data,
                    status: r.status
                };
            }
            logger(`API Request Success: ${method} ${path}`, 'debug');
            return {
                data,
                status: r.status
            };
        } catch (e) {
            logger(`API Request Failed (Network): ${method} ${path} - ${e.message}`, 'error');
            return {
                error: {
                    message: "Network error"
                },
                status: 0
            };
        }
    }

    async function addAccount(token) {
        document.getElementById('login-error').innerText = "";
        if (!token || !token.trim()) {
            document.getElementById('login-error').innerText = "„Éà„Éº„ÇØ„É≥„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ";
            logger('Login failed: Token missing.', 'warn');
            return
        }
        token = token.trim().replace(/^"|"$/g, '');
        const b = document.getElementById('add-account-button');
        const t = document.getElementById('add-account-button-text');
        const s = document.getElementById('login-spinner');
        t.classList.add('hidden');
        s.classList.remove('hidden');
        b.disabled = true;
        logger('Attempting to verify token and fetch user details...', 'info');
        const result = await apiRequest(token, '/users/@me');
        t.classList.remove('hidden');
        s.classList.add('hidden');
        b.disabled = false;
        if (result.data && result.data.id) {
            logger(`Token verified for user: ${result.data.username}`, 'success');
            const a = getAccounts();
            const i = a.findIndex(acc=>acc.id === result.data.id);
            const n = {
                ...result.data,
                token
            };
            if (i > -1) a[i] = n;
            else a.push(n);
            saveAccounts(a);
            switchAccount(result.data.id);
        } else {
            document.getElementById('login-error').innerText = `„Ç®„É©„Éº: ${result.error?.message || 'ÁÑ°Âäπ„Å™„Éà„Éº„ÇØ„É≥„ÅãAPI„Ç®„É©„Éº„Åß„Åô„ÄÇ'}`;
            logger(`Token verification failed. Status: ${result.status}`, 'error');
        }
    }
    function switchAccount(id) {
        cleanupState();
        setActiveAccountId(id);
        const a = getAccounts().find(a=>a.id === id);
        if (!a) {
            showLoginScreen();
            return
        }
        currentAccount = a;
        document.getElementById('token-input').value = '';
        updateView('app');
        renderUserInfo();
        renderAccountSwitcher();
        loadGuilds();
        connectWS();
        logger(`Switched to account: ${currentAccount.username}`, 'info');
    }
    function deleteAccount(id, e) {
        e.stopPropagation();
        if (!confirm("„Åì„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
        let a = getAccounts();
        a = a.filter(acc=>acc.id !== id);
        saveAccounts(a);
        logger(`Deleted account ID: ${id}`, 'info');
        if (getActiveAccountId() === id) {
            if (a.length > 0) switchAccount(a[0].id);
            else {
                localStorage.removeItem('activeAccountId');
                showLoginScreen();
            }
        } else renderAccountSwitcher();
    }

    function getAvatarUrl(user, size=64) {
        if (user.avatar) return `https://yakisoba.cloudfree.jp/avoidcord/avatars/${user.id}/${user.avatar}.png?size=${size}`;
        return `https://yakisoba.cloudfree.jp/avoidcord/embed/avatars/${user.discriminator % 5}.png`;
    }
    function renderStatusDot(status) {
        const dot = document.createElement('div');
        dot.className = `status-dot ${status || 'offline'}`;
        return dot.outerHTML;
    }

    function renderUserInfo() {
        if (!currentAccount) return;
        const p = document.getElementById('user-info-panel');
        const avatarUrl = getAvatarUrl(currentAccount);
        const status = getStatus();
        p.innerHTML = `
            <div class="relative w-10 h-10 flex-shrink-0">
                <img src="${avatarUrl}" class="w-full h-full rounded-full">
                ${renderStatusDot(status)}
            </div>
            <div class="flex-1 truncate">
                <b class="text-sm truncate">${currentAccount.global_name || currentAccount.username}</b>
                <div class="text-xs opacity-60 truncate">@${currentAccount.username}</div>
            </div>
        `;
    }
    
    function renderAccountSwitcher() {
        const l = document.getElementById('account-list');
        const a = getAccounts();
        const i = getActiveAccountId();
        l.innerHTML = a.map(acc=>{
            const av = getAvatarUrl(acc);
            const isA = acc.id === i;
            return `<div class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-gray-500/20" onclick="switchAccount('${acc.id}')">
                <img src="${av}" class="w-8 h-8 rounded-full">
                <span class="flex-1 truncate text-sm font-semibold">${acc.global_name || acc.username}</span> 
                ${isA ? '<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>' : ''} 
                <div onclick="deleteAccount('${acc.id}',event)" title="ÂâäÈô§" class="p-1 rounded-full text-red-500 hover:bg-red-500/20">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                </div>
            </div>`;
        }).join('');
    }
    
    async function updateStatus(status) {
        if (!currentAccount) return;
        setStatus(status);
        renderUserInfo();
        document.getElementById('status-picker').classList.add('hidden');
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                op: 3,
                d: {
                    status: status,
                    since: 0,
                    afk: status === 'idle'
                }
            }));
            logger(`Status updated to: ${status}`, 'info');
        } else {
            logger('WebSocket not open. Status updated locally.', 'warn');
        }
    }


    async function loadGuilds() {
        if (!currentAccount) return;
        const {data: g} = await apiRequest(currentAccount.token, '/users/@me/guilds');
        if (!g) return;
        const l = document.getElementById('guild-list');
        l.innerHTML = '';
        g.forEach(s=>{
            let el = document.createElement('div');
            el.id = `guild-${s.id}`;
            el.className = 'server-icon cursor-pointer';
            el.title = s.name;
            el.onclick = ()=>loadChannels(s, el);
            if (s.icon) {
                el.innerHTML = `<img src="https://yakisoba.cloudfree.jp/avoidcord/icons/${s.id}/${s.icon}.png?size=128" class="object-cover w-full h-full rounded-full">`
            } else {
                el.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-700 text-white font-bold rounded-full">${s.name.replace(/[^\w\s]/gi, '').split(' ').map(w=>w[0]).join('').substring(0, 2)}</div>`
            }
            l.appendChild(el);
        }
        );
        logger(`Loaded ${g.length} guilds.`, 'info');
    }
    async function loadChannels(g, t) {
        if (!currentAccount) return;
        document.querySelectorAll('.server-icon.active').forEach(e=>e.classList.remove('active'));
        if (t) t.classList.add('active');
        document.getElementById('guild-name').innerText = g.name;
        const {data: c} = await apiRequest(currentAccount.token, `/guilds/${g.id}/channels`);
        if (!c) return;
        const l = document.getElementById('channel-list');
        l.innerHTML = '';
        const p = c.reduce((a,ch)=>{
            (a[ch.parent_id || 'null'] = a[ch.parent_id || 'null'] || []).push(ch);
            return a;
        }
        , {});
        Object.values(p).forEach(a=>a.sort((x,y)=>x.position - y.position));
        const r = ch=>{
            if (ch.type !== 0 && ch.type !== 5 && ch.type !== 2) return;
            const d = document.createElement('div');
            d.id = `channel-${ch.id}`;
            d.className = 'channel-item p-2 rounded cursor-pointer mb-1 text-sm truncate';
            d.innerHTML = `<span>${ch.type === 2 ? 'üîä' : '#'} ${ch.name}</span>`;
            if (ch.type !== 2) d.onclick = ()=>selectChannel(ch);
            else d.classList.add('opacity-50', 'cursor-not-allowed');
            l.appendChild(d);
        }
        ;
        (p['null'] || []).forEach(r);
        c.filter(i=>i.type === 4).sort((x,y)=>x.position - y.position).forEach(cat=>{
            const h = document.createElement('div');
            h.className = 'px-1 pt-4 pb-1 text-xs font-bold uppercase text-[var(--text-secondary)]';
            h.innerText = cat.name;
            l.appendChild(h);
            (p[cat.id] || []).forEach(r);
        }
        );
        updatePingDots();
        logger(`Loaded ${c.length} channels for guild: ${g.name}`, 'info');
    }
    async function loadDms(t) {
        if (!currentAccount) return;
        document.querySelectorAll('.server-icon.active').forEach(e => e.classList.remove('active'));
        if (t) t.classList.add('active');
        document.getElementById('guild-name').innerText = 'Direct Messages';
        const {data: d} = await apiRequest(currentAccount.token, '/users/@me/channels');
        if (!d) return;
        const l = document.getElementById('channel-list');
        l.innerHTML = '';
        d.sort((a,b)=>(b.last_message_id || '0').localeCompare(a.last_message_id || '0')).forEach(dm => {
            const recipient = dm.recipients?.[0] || {};
            const name = dm.name || recipient.global_name || recipient.username || 'DM';
            const avatar = getAvatarUrl(recipient);

            const el = document.createElement('div');
            el.id = `channel-${dm.id}`;
            el.className = 'channel-item p-2 rounded cursor-pointer mb-1 text-sm truncate flex items-center gap-3';
            el.innerHTML = `<img src="${avatar}" class="w-8 h-8 rounded-full"> <span class="flex-1">${name}</span>`;
            el.onclick = () => selectChannel(dm);
            l.appendChild(el);
        });
        updatePingDots();
        logger(`Loaded ${d.length} DMs.`, 'info');
    }


    async function selectChannel(ch) {
        currentChannel = ch;
        oldestMessageId = null;
        lastMessageInfo = {
            authorId: null,
            timestamp: null
        };
        isLoadingMore = false;
        cancelReply();
        cancelAttachment();
        updatePings(ch.id, 0, true);
        document.querySelectorAll('.channel-item.active').forEach(e=>e.classList.remove('active'));
        const cE = document.getElementById(`channel-${ch.id}`);
        if (cE) cE.classList.add('active');
        if (window.innerWidth < 768) showChatView();
        let name = ch.name || ch.recipients?.[0]?.global_name || ch.recipients?.[0]?.username || 'DM';
        document.getElementById('channel-name-text').innerHTML = `<span class="text-gray-500 mr-1">${ch.guild_id ? '#' : ''}</span><span>${name}</span>`;
        const con = document.getElementById('message-container');
        con.innerHTML = '<div class="m-auto text-xs opacity-50">„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>';
        logger(`Selected channel: ${name} (${ch.id})`, 'info');

        const {data: ms} = await apiRequest(currentAccount.token, `/channels/${ch.id}/messages?limit=100`);
        con.innerHTML = '';
        if (Array.isArray(ms) && ms.length > 0) {
            const lastReadId = ms[0].id;
            oldestMessageId = ms[ms.length - 1].id;
            ms.reverse().forEach(m=>renderMsg(m, false, false));
            const isScrolledToBottom = (con.scrollHeight - con.scrollTop - con.clientHeight) < 1;
            if(isScrolledToBottom) {
                 await apiRequest(currentAccount.token, `/channels/${ch.id}/messages/${lastReadId}/ack`, 'POST', {});
            }
            setTimeout(()=>con.scrollTop = con.scrollHeight, 0);
        } else {
             con.innerHTML = '<div class="m-auto text-xs opacity-50">„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>';
        }
        if (ch.guild_id) checkTimeoutStatus(ch.guild_id);
        else setInputState(true);
    }
    async function loadMoreMessages() {
        if (isLoadingMore || !oldestMessageId || !currentChannel) return;
        isLoadingMore = true;
        const con = document.getElementById('message-container');
        const oldHeight = con.scrollHeight;
        logger(`Loading messages before: ${oldestMessageId}`, 'debug');

        const {data: m} = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages?limit=100&before=${oldestMessageId}`);
        if (Array.isArray(m) && m.length > 0) {
            oldestMessageId = m[m.length - 1].id;
            m.reverse().forEach(msg=>renderMsg(msg, false, true));
            con.scrollTop = con.scrollHeight - oldHeight;
            logger(`Loaded ${m.length} older messages.`, 'debug');
        } else {
            oldestMessageId = null;
            const topEl = document.createElement('div');
            topEl.className = 'text-center text-xs opacity-50 py-4';
            topEl.innerText = '„Åì„Çå‰ª•‰∏äÂè§„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
            con.prepend(topEl);
            logger('No more older messages found.', 'debug');
        }
        isLoadingMore = false;
    }
    function scrollToMessage(id) {
        const el = document.getElementById(`message-${id}`);
        if(el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.classList.add('bg-yellow-500/10', 'transition-all', 'duration-1000');
            setTimeout(()=>el.classList.remove('bg-yellow-500/10'), 2000);
        }
    }
    
    function renderMsg(m, isNew, isPrepended=false) {
        if (!m.author || !currentAccount) return;

        // Blocked User Check
        const blockedUsers = getBlockedUsers();
        if (blockedUsers.includes(m.author.id)) {
            logger(`Message from blocked user (${m.author.username}) skipped.`, 'debug');
            if (!isPrepended) {
                 lastMessageInfo = { authorId: null, timestamp: null }; // Grouping reset
            }
            return;
        }

        const p = document.getElementById('message-container');
        const isGrouped = !isPrepended && m.author.id === lastMessageInfo.authorId && (new Date(m.timestamp) - new Date(lastMessageInfo.timestamp)) < 300 * 1000;
        
        let originalContent = m.content;
        const urlRegex = /(https?:\/\/[^\s<>"']+)/g;
        let contentHtml = m.content
            .replace(/</g, '&lt;').replace(/>/g, '&gt;')
            .replace(urlRegex, '<a href="$1" target="_blank" class="text-[var(--text-link)] hover:underline">$1</a>')
            .replace(/\n/g, '<br>')
            .replace(/&lt;@!?(\d+)&gt;/g, (_,id)=>{
                const u = m.mentions.find(mu=>mu.id === id) || m.author.id === id ? m.author : null;
                return u ? `<span class="mention" onclick="openProfileModal('${u.id}', '${m.guild_id || ''}')">@${u.global_name || u.username}</span>` : '@unknown-user';
            })
            .replace(/&lt;a?:(\w+):(\d+)&gt;/g, (_,n,i)=>`<img src="https://yakisoba.cloudfree.jp/avoidcord/emojis/${i}.webp?size=48&quality=lossless" alt=":${n}:" class="inline h-6 w-6">`);

        if (m.sticker_items) contentHtml += m.sticker_items.map(s=>`<img src="https://yakisoba.cloudfree.jp/avoidcord/stickers/${s.id}.webp?size=160" alt="${s.name}" class="w-32 h-32 mt-2"/>`).join('');
        if (m.attachments?.length > 0) contentHtml += m.attachments.map(a=>{
            if (a.content_type?.startsWith('image')) return `<br><a href="${a.url}" target="_blank"><img src="${a.url}" class="max-w-xs cursor-pointer rounded-lg mt-2" style="display: block;"/></a>`;
            if (a.content_type?.startsWith('video')) return `<br><video src="${a.url}" controls playsinline muted class="max-w-xs rounded-lg mt-2"></video>`;
            return `<div class="mt-2 p-3 rounded-md text-[var(--text-primary)]" style="background-color:var(--bg-tertiary);"><a href="${a.url}" target="_blank" class="text-[var(--text-link)]">${a.filename}</a></div>`
        }).join('');
        
        let replyHtml = '';
        if (m.referenced_message) {
            const rm = m.referenced_message;
            const rAuth = rm.author;
            const rAuthName = rAuth.global_name || rAuth.username;
            const rCont = rm.content ? rm.content.substring(0, 100) : 'Ê∑ª‰ªò„Éï„Ç°„Ç§„É´';
            const rAuthAvatar = getAvatarUrl(rAuth, 32);

            replyHtml = `
                <div class="relative ml-14 flex items-center cursor-pointer" onclick="scrollToMessage('${rm.id}')">
                    <div style="bottom: -28px;" class="absolute -left-10 top-0 w-8 border-l-2 border-t-2 border-gray-400 dark:border-gray-600 rounded-tl-md"></div>
                    <img src="${rAuthAvatar}" class="w-4 h-4 rounded-full mr-2">
                    <b class="mr-2 text-sm text-[var(--text-link)]">${rAuthName}</b>
                    <span class="truncate text-xs opacity-70">${rCont}</span>
                </div>`;
        }
        if (m.embeds?.length > 0) contentHtml += m.embeds.map(renderEmbed).join('');
        const displayName = m.author.global_name || m.author.username;
        const nm = `<span class="cursor-pointer" onclick="openProfileModal('${m.author.id}', '${m.guild_id || ''}')">${displayName}</span> <span class="text-xs opacity-60">(@${m.author.username})</span>`;
        const av = getAvatarUrl(m.author);
        const el = document.createElement('div');
        el.id = `message-${m.id}`;
        el.className = "px-4 message-group relative";
        const isAuthor = m.author.id === currentAccount.id;
        const toolbarHtml = `<div class="message-toolbar absolute -top-4 right-2 flex items-center gap-1 p-1 rounded-md shadow" style="background-color:var(--bg-secondary); color: var(--text-secondary);"> <button onclick='startReply(${JSON.stringify({id: m.id, author: m.author})})' title="Reply" class="p-1"><svg class="w-4 h-4" viewBox="0 0 24 24"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z" fill="currentColor"/></svg></button> ${isAuthor ? `<button onclick='startEdit("${m.id}")' class="p-1" title="Edit"><svg class="w-4 h-4" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" fill="currentColor"></path></svg></button> <button onclick='deleteMessage("${m.id}")' class="p-1" title="Delete"><svg class="w-4 h-4" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" fill="currentColor"></path></svg></button>` : ''}</div>`;
        if (isGrouped) {
            el.innerHTML = `<div class="flex pl-14 pt-0.5"><div class="text-sm break-words message-content-text">${contentHtml}</div></div> ${toolbarHtml}`;
        } else {
            el.innerHTML = `${replyHtml}<div class="flex gap-3 pt-4"><img src="${av}" class="w-10 h-10 rounded-full mt-0.5 flex-shrink-0 cursor-pointer" onclick="openProfileModal('${m.author.id}', '${m.guild_id || ''}')"><div class="flex-1 min-w-0"><div><b class="text-sm">${nm}</b><span class="text-xs opacity-40 ml-2">${new Date(m.timestamp).toLocaleString()}</span></div><div class="text-sm break-words message-content-text">${contentHtml}</div></div></div> ${toolbarHtml}`;
        }
        el.querySelector('.message-content-text').dataset.originalContent = originalContent;
        if (isPrepended) {
            p.prepend(el);
        } else {
            p.appendChild(el);
        }
        
        if (!isPrepended) {
             if (!isGrouped) {
                 lastMessageInfo = { authorId: m.author.id, timestamp: m.timestamp };
             } else {
                 lastMessageInfo.timestamp = m.timestamp;
             }
        }
    }
    function renderEmbed(e) {
        const color = e.color ? `#${e.color.toString(16).padStart(6, '0')}` : 'var(--border-color)';
        let fields = e.fields ? e.fields.map(f=>`<div class="${f.inline ? 'inline-block mr-4' : 'block'} min-w-[150px]"><b class="block">${f.name}</b><span>${f.value}</span></div>`).join('') : '';
        return `<div class="mt-2 p-3 rounded-md flex gap-4" style="background-color: var(--bg-quaternary); border-left: 4px solid ${color};"> ${e.thumbnail ? `<a href="${e.thumbnail.url}" target="_blank"><img src="${e.thumbnail.proxy_url}" class="max-w-[80px] max-h-[80px] object-contain rounded-md"></a>` : ''} <div class="text-sm flex-1 min-w-0"> ${e.author ? `<div class="font-bold flex items-center gap-2 mb-1">${e.author.icon_url ? `<img src="${e.author.proxy_icon_url}" class="w-6 h-6 rounded-full">` : ''}<a href="${e.author.url || '#'}" target="_blank" class="hover:underline">${e.author.name}</a></div>` : ''} ${e.title ? `<a href="${e.url || '#'}" target="_blank" class="font-bold text-base block text-[var(--text-link)] hover:underline">${e.title}</a>` : ''} ${e.description ? `<div class="mt-1">${e.description}</div>` : ''} ${fields ? `<div class="mt-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">${fields}</div>` : ''} ${e.image ? `<a href="${e.image.url}" target="_blank"><img src="${e.image.proxy_url}" class="mt-2 rounded-lg max-w-xs"></a>` : ''} ${e.footer ? `<div class="mt-2 text-xs opacity-70 flex items-center gap-1.5">${e.footer.icon_url ? `<img src="${e.footer.proxy_icon_url}" class="w-4 h-4 rounded-full">` : ''}${e.footer.text}</div>` : ''} </div></div>`;
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const content = input.value.trim();
        if (!currentChannel || (!content && !attachedFile)) return;
        if (content.length > 2000) {
            if (confirm("„É°„ÉÉ„Çª„Éº„Ç∏„Åå2000ÊñáÂ≠ó„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶ÈÄÅ‰ø°„Åó„Åæ„Åô„ÅãÔºü")) {
                attachedFile = new File([content],"message.txt");
                return sendMessageWithFile({})
            }
            return;
        }
        const payload = {
            content,
            nonce: Date.now().toString(),
            tts: false
        };
        if (replyingTo) payload.message_reference = {
            message_id: replyingTo.messageId
        };
        if (attachedFile) return sendMessageWithFile(payload);
        
        const originalContent = input.value;
        input.value = '';
        handleInput();
        cancelReply();
        logger(`Sending message to channel ${currentChannel.id}: ${content.substring(0, 50)}...`, 'info');
        
        const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages`, 'POST', payload);
        if (res.error) {
            input.value = originalContent;
            handleInput();
            const msg = res.error.message || 'ÈÄÅ‰ø°Â§±Êïó';
            logger(`Message send failed: ${msg}`, 'error');
        } else {
             logger('Message sent successfully.', 'success');
        }
    }
    async function sendMessageWithFile(payload={}) {
        if (!attachedFile) return;
        const fd = new FormData();
        fd.append('files[0]', attachedFile, attachedFile.name);
        fd.append('payload_json', JSON.stringify(payload));
        const input = document.getElementById('message-input');
        if (payload.content) input.value = '';
        handleInput();
        cancelReply();
        cancelAttachment();
        logger(`Sending file: ${attachedFile.name}`, 'info');

        const res = await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages`, 'POST', fd, true);
        if (res.error) logger(`File send failed: ${res.error.message || 'Unknown error'}`, 'error');
        else logger('File sent successfully.', 'success');
    }
    function startReply(m) {
        replyingTo = {
            messageId: m.id
        };
        document.getElementById('reply-bar').classList.remove('hidden');
        document.getElementById('reply-username').innerText = `@${m.author.global_name || m.author.username}`;
        document.getElementById('message-input').focus();
        logger(`Starting reply to message: ${m.id}`, 'info');
    }
    function cancelReply() {
        replyingTo = null;
        document.getElementById('reply-bar').classList.add('hidden');
        logger('Reply cancelled.', 'info');
    }
    async function deleteMessage(id) {
        if (!currentChannel) return;
        if (confirm("Êú¨ÂΩì„Å´„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
            await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages/${id}`, 'DELETE');
            logger(`Message ID ${id} deleted.`, 'info');
        }
    }
    function startEdit(id) {
        const msgEl = document.getElementById(`message-${id}`);
        if (!msgEl) return;
        const contentEl = msgEl.querySelector('.message-content-text');
        if (!contentEl) return;
        const original = contentEl.dataset.originalContent;
        contentEl.innerHTML = `<textarea class="input-field w-full p-2 text-sm">${original}</textarea><div class="text-xs mt-1">esc„Åß<b class="text-[var(--text-link)] cursor-pointer">„Ç≠„É£„É≥„Çª„É´</b> ‚Ä¢ enter„Åß<b class="text-[var(--text-link)] cursor-pointer">‰øùÂ≠ò</b></div>`;
        const textarea = contentEl.querySelector('textarea');
        textarea.focus();
        textarea.selectionStart = textarea.value.length;
        textarea.onkeydown = e=>{
            if (e.key === 'Escape') {
                e.preventDefault();
                cancelEdit(id, original);
            }
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                saveEdit(id);
            }
        }
        ;
        contentEl.querySelectorAll('b')[0].onclick = ()=>cancelEdit(id, original);
        contentEl.querySelectorAll('b')[1].onclick = ()=>saveEdit(id);
        logger(`Starting edit for message: ${id}`, 'info');
    }
    function cancelEdit(id, original) {
        const el = document.getElementById(`message-${id}`)?.querySelector('.message-content-text');
        if (el) el.innerHTML = original.replace(/\n/g, '<br>');
        logger(`Edit cancelled for message: ${id}`, 'info');
    }
    async function saveEdit(id) {
        const el = document.getElementById(`message-${id}`);
        const textarea = el?.querySelector('textarea');
        if (!textarea) return;
        const newContent = textarea.value.trim();
        if (newContent) {
            await apiRequest(currentAccount.token, `/channels/${currentChannel.id}/messages/${id}`, 'PATCH', {
                content: newContent
            });
            logger(`Message ID ${id} edited.`, 'info');
        } else {
            deleteMessage(id);
        }
    }

    function setAttachment(file) {
        if (!file) return;
        attachedFile = file;
        document.getElementById('attachment-preview-name').textContent = file.name;
        document.getElementById('attachment-preview-bar').classList.remove('hidden');
        handleInput();
        logger(`Attachment set: ${file.name}`, 'info');
    }
    function cancelAttachment() {
        attachedFile = null;
        document.getElementById('file-input').value = "";
        document.getElementById('attachment-preview-bar').classList.add('hidden');
        handleInput();
        logger('Attachment cancelled.', 'info');
    }

    function connectWS() {
        if (!currentAccount || !currentAccount.token) return;
        if (ws) ws.close();
        ws = new WebSocket('wss://gateway.discord.gg/?v=10&encoding=json');
        let lastMessageId = null;

async function pollMessages() {
    try {
        const res = await fetch("https://yakisoba.cloudfree.jp/avoidcord/messages?limit=50");
        const data = await res.json();
        if (!data || !data.messages) return;

        for (const msg of data.messages.reverse()) {
            if (msg.id === lastMessageId) continue;
            renderMessage(msg);
            lastMessageId = msg.id;
        }
    } catch (e) {
        console.error(e);
    }
}

setInterval(pollMessages, 1000);

        
        ws.onopen = () => logger('WebSocket connected.', 'success');
        ws.onmessage = e=>{
            const d = JSON.parse(e.data);
            if (d.s) lastSequence = d.s;
            // logger(`WS Event: OP=${d.op}, T=${d.t}`, 'debug');

            if (d.op === 10) {
                if (heartbeatInterval) clearInterval(heartbeatInterval);
                heartbeatInterval = setInterval(()=>ws.send(JSON.stringify({
                    op: 1,
                    d: lastSequence
                })), d.d.heartbeat_interval);
                ws.send(JSON.stringify({
                    op: 2,
                    d: {
                        token: currentAccount.token,
                        properties: {
                            $os: "windows",
                            $browser: "chrome",
                            $device: ""
                        },
                        presence: {
                            status: getStatus(), // Set initial status
                            since: 0,
                            afk: getStatus() === 'idle'
                        }
                    }
                }));
                logger('Received Hello, sent Identify.', 'info');
            } else if (d.t === 'READY') {
                logger('Received READY event.', 'info');
            } else if (d.t === 'MESSAGE_CREATE') {
                const con = document.getElementById('message-container');
                const isScrolled = (con.scrollHeight - con.scrollTop - con.clientHeight) < 100;
                if (d.d.channel_id === currentChannel?.id) {
                    renderMsg(d.d, true, false);
                    if (isScrolled) {
                        con.scrollTop = con.scrollHeight;
                        apiRequest(currentAccount.token, `/channels/${d.d.channel_id}/messages/${d.d.id}/ack`, 'POST', {});
                    }
                } else if (d.d.guild_id && (d.d.mentions?.some(u=>u.id === currentAccount.id) || d.d.mention_everyone)) {
                    updatePings(d.d.channel_id, 1, false, d.d.guild_id);
                } else if (!d.d.guild_id) {
                    updatePings(d.d.channel_id, 1, true)
                }
            } else if (d.t === 'MESSAGE_DELETE' && d.d.channel_id === currentChannel?.id) document.getElementById(`message-${d.d.id}`)?.remove();
            else if (d.t === 'MESSAGE_UPDATE' && d.d.channel_id === currentChannel?.id) {
                const el = document.getElementById(`message-${d.d.id}`);
                if (el) {
                    el.querySelector('.message-content-text').innerHTML = d.d.content.replace(/\n/g, '<br>');
                }
            }
        }
        ;
        ws.onclose = ()=>{
            logger('WebSocket closed. Attempting reconnect in 5s.', 'warn');
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (currentAccount) setTimeout(connectWS, 5000);
        }
        ;
        ws.onerror = e=>{
            logger('WS Error occurred, closing connection.', 'error');
            ws.close();
        }
        ;
    }
    function updatePings(id, count, isDm, guildId=null) {
        if (count > 0) {
            if (isDm) pingCounts[id] = {
                isDm: true
            };
            else pingCounts[id] = {
                isDm: false,
                guildId: guildId
            };
        } else {
            delete pingCounts[id];
        }
        updatePingDots();
    }
    function updatePingDots() {
        document.querySelectorAll('.ping-dot').forEach(d=>d.remove());
        Object.keys(pingCounts).forEach(id=>{
            const el = document.getElementById(`channel-${id}`);
            if (el && !el.querySelector('.ping-dot')) el.insertAdjacentHTML('beforeend', '<div class="ping-dot"></div>');
            const {guildId} = pingCounts[id];
            if (guildId) {
                const gEl = document.getElementById(`guild-${guildId}`);
                if (gEl && !gEl.querySelector('.ping-dot')) gEl.insertAdjacentHTML('beforeend', '<div class="ping-dot"></div>');
            }
        }
        );
    }

    async function checkTimeoutStatus(guildId) {
        if (timeoutInterval) clearInterval(timeoutInterval);
        const {data: m} = await apiRequest(currentAccount.token, `/guilds/${guildId}/members/${currentAccount.id}`);
        const end = m && m.communication_disabled_until ? new Date(m.communication_disabled_until) : null;
        if (end && end > new Date()) {
            const update = ()=>{
                const now = new Date();
                const diff = (end - now) / 1000;
                if (diff <= 0) {
                    setInputState(true);
                    clearInterval(timeoutInterval);
                    logger('Timeout ended.', 'info');
                } else {
                    const d = Math.floor(diff / 86400);
                    const h = Math.floor(diff / 3600) % 24;
                    const min = Math.floor(diff / 60) % 60;
                    const s = Math.floor(diff % 60);
                    setInputState(false, `„Çø„Ç§„É†„Ç¢„Ç¶„Éà‰∏≠: ${d > 0 ? `${d}d` : ''} ${h.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`);
                }
            }
            ;
            update();
            timeoutInterval = setInterval(update, 1000);
            logger('User is currently timed out.', 'warn');
        } else {
            setInputState(true);
            logger('User is not timed out.', 'info');
        }
    }
    function setInputState(enabled, placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°") {
        const i = document.getElementById('message-input');
        const s = document.getElementById('send-button');
        i.disabled = !enabled;
        i.placeholder = placeholder;
        s.disabled = !enabled || (i.value.trim() === '' && !attachedFile);
    }
    function handleInput() {
        const i = document.getElementById('message-input');
        const c = document.getElementById('char-counter');
        const p = document.getElementById('slash-command-picker');
        const l = i.value.length;
        i.style.height = 'auto';
        i.style.height = (i.scrollHeight) + 'px';
        setInputState(!i.disabled);
        c.textContent = l > 0 ? `${l}/2000` : '';
        c.style.color = l > 2000 ? 'red' : '';
        if (i.value.startsWith('/')) p.classList.remove('hidden');
        else p.classList.add('hidden');
    }

    // Profile and Block Functions
    async function openProfileModal(userId, guildId) {
        if (!currentAccount || userId === currentAccount.id) return; // Can't view own profile
        logger(`Opening profile for user ID: ${userId} in guild: ${guildId || 'DM'}`, 'info');
        const modal = document.getElementById('profile-modal');
        const blockBtn = document.getElementById('block-user-btn');
        let user;
        let member;
        
        // 1. Fetch User Data
        const userRes = await apiRequest(currentAccount.token, `/users/${userId}`);
        if (!userRes.data) {
             logger(`Failed to fetch user data for ${userId}`, 'error');
             return;
        }
        user = userRes.data;

        // 2. Fetch Member Data (if in guild)
        if (guildId) {
            const memberRes = await apiRequest(currentAccount.token, `/guilds/${guildId}/members/${userId}`);
            member = memberRes.data;
        }

        // 3. Render Profile
        const avatarUrl = getAvatarUrl(user, 128);
        document.getElementById('profile-avatar').src = avatarUrl;
        document.getElementById('profile-name').innerText = user.global_name || user.username;
        document.getElementById('profile-username').innerText = `@${user.username}`;
        
        // Status is not reliably available from the API in this way, defaulting to offline/placeholder
        // Note: For a true status, we'd need to track PRESENCE_UPDATE events via WebSocket.
        const statusDot = document.getElementById('profile-status-dot');
        statusDot.className = 'status-dot offline w-5 h-5'; // Default to offline
        
        // Member details
        const memberSince = document.getElementById('profile-member-since');
        if (member?.joined_at) {
            memberSince.innerText = new Date(member.joined_at).toLocaleDateString();
        } else {
            memberSince.innerText = 'ÊÉÖÂ†±„Å™„Åó';
        }

        // 4. Block Button Setup
        const blockedUsers = getBlockedUsers();
        const isBlocked = blockedUsers.includes(userId);
        blockBtn.dataset.userId = userId;
        blockBtn.dataset.isBlocked = isBlocked;
        blockBtn.innerText = isBlocked ? '„É¶„Éº„Ç∂„Éº„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíËß£Èô§' : '„É¶„Éº„Ç∂„Éº„Çí„Éñ„É≠„ÉÉ„ÇØ';
        blockBtn.className = isBlocked 
            ? 'w-full bg-gray-600 hover:bg-gray-700 py-2 mt-4 rounded-md font-bold text-white' 
            : 'w-full bg-red-600 hover:bg-red-700 py-2 mt-4 rounded-md font-bold text-white';
        blockBtn.onclick = () => toggleBlockUser(userId);

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeProfileModal() {
        document.getElementById('profile-modal').classList.add('hidden');
        document.getElementById('profile-modal').classList.remove('flex');
        logger('Profile modal closed.', 'info');
    }

    function toggleBlockUser(userId) {
        let blockedUsers = getBlockedUsers();
        const blockBtn = document.getElementById('block-user-btn');

        if (blockedUsers.includes(userId)) {
            // Unblock
            blockedUsers = blockedUsers.filter(id => id !== userId);
            blockBtn.innerText = '„É¶„Éº„Ç∂„Éº„Çí„Éñ„É≠„ÉÉ„ÇØ';
            blockBtn.className = 'w-full bg-red-600 hover:bg-red-700 py-2 mt-4 rounded-md font-bold text-white';
            logger(`User ID ${userId} unblocked.`, 'info');
        } else {
            // Block
            blockedUsers.push(userId);
            blockBtn.innerText = '„É¶„Éº„Ç∂„Éº„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíËß£Èô§';
            blockBtn.className = 'w-full bg-gray-600 hover:bg-gray-700 py-2 mt-4 rounded-md font-bold text-white';
            logger(`User ID ${userId} blocked.`, 'warn');
        }
        saveBlockedUsers(blockedUsers);
        closeProfileModal();

        // Reload current channel to hide/show messages
        if (currentChannel) selectChannel(currentChannel);
    }
    
    // UI/View functions (no change)
    function updateView(state) {
        const a = document.getElementById('auth-section');
        const m = document.getElementById('main-app');
        if (state === 'auth') {
            a.classList.remove('hidden');
            a.classList.add('flex');
            m.classList.add('hidden');
            document.getElementById('cancel-add-account-button').style.display = getAccounts().length > 0 ? 'block' : 'none';
        } else {
            a.classList.add('hidden');
            a.classList.remove('flex');
            m.classList.remove('hidden');
            m.classList.add('flex');
            handleResize();
        }
    }
    function applyTheme() {
        const b = document.getElementById('theme-toggle-btn');
        if (localStorage.theme === 'dark' || (!('theme'in localStorage) && window.matchMedia('(prefers-color-scheme:dark)').matches)) {
            document.documentElement.classList.add('dark');
            b.innerHTML = sunIcon;
        } else {
            document.documentElement.classList.remove('dark');
            b.innerHTML = moonIcon;
        }
    }
    function handleResize() {
        if (window.innerWidth >= 768) {
            showChatView();
            document.getElementById('sidebar-view').classList.remove('hidden');
        } else {
            if (currentChannel) showChatView();
            else showSidebarView();
        }
    }
    function showSidebarView() {
        currentChannel = null;
        document.getElementById('sidebar-view').classList.remove('hidden');
        document.getElementById('chat-section').classList.add('hidden');
    }
    function showChatView() {
        document.getElementById('sidebar-view').classList.add('hidden');
        document.getElementById('chat-section').classList.remove('hidden');
        document.getElementById('chat-section').classList.add('flex');
    }

    document.addEventListener('DOMContentLoaded', ()=>{
        applyTheme();
        const a = getAccounts();
        let i = getActiveAccountId();
        if (a.length > 0 && a.find(acc=>acc.id === i)) switchAccount(i);
        else if (a.length > 0) switchAccount(a[0].id);
        else {
            showLoginScreen();
        }
        function showLoginScreen() {
            updateView('auth')
        }
        document.getElementById('add-account-button').onclick = ()=>addAccount(document.getElementById('token-input').value);
        document.getElementById('dm-icon').onclick = e=>loadDms(e.currentTarget);
        document.getElementById('send-button').onclick = sendMessage;
        document.getElementById('cancel-reply-btn').onclick = cancelReply;
        document.getElementById('cancel-attachment-btn').onclick = cancelAttachment;
        document.getElementById('attach-button').onclick = ()=>document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = e=>{
            if (e.target.files.length > 0) setAttachment(e.target.files[0]);
        }
        ;
        document.getElementById('back-to-channels-btn').onclick = showSidebarView;
        document.getElementById('message-input').addEventListener('input', handleInput);
        document.getElementById('message-input').addEventListener('keypress', e=>{
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        );
        document.getElementById('message-container').addEventListener('scroll', e=>{
            if (e.target.scrollTop < 100 && oldestMessageId) loadMoreMessages()
        }
        );
        document.body.addEventListener('paste', e=>{
            const file = e.clipboardData.files[0];
            if (file) {
                e.preventDefault();
                setAttachment(file);
            }
        }
        );
        document.getElementById('theme-toggle-btn').addEventListener('click', ()=>{
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            applyTheme();
        }
        );
        
        // Status picker toggle
        document.getElementById('user-info-panel').onclick = (e)=>{
             // Prevent the account switcher from opening if the status picker is open
             if(e.target.closest('#status-picker')) return; 

             const switcher = document.getElementById('account-switcher');
             const picker = document.getElementById('status-picker');

             // If the click is on the user info panel area (not on an account switcher item)
             if(e.target.closest('#user-info-panel')) {
                 if (!picker.classList.contains('hidden')) {
                     picker.classList.add('hidden');
                     switcher.classList.toggle('hidden');
                 } else {
                     picker.classList.remove('hidden');
                     switcher.classList.add('hidden'); // Close switcher if picker is opened
                 }
             }
        };

        // Click outside handler for status picker and account switcher
        document.addEventListener('click', (e) => {
            const picker = document.getElementById('status-picker');
            const switcher = document.getElementById('account-switcher');
            const infoPanel = document.getElementById('user-info-panel');
            
            if (!infoPanel.contains(e.target) && !picker.contains(e.target) && !switcher.contains(e.target)) {
                picker.classList.add('hidden');
                switcher.classList.add('hidden');
            }
        });


        document.getElementById('add-account-switcher-btn').onclick = ()=>{
            document.getElementById('account-switcher').classList.add('hidden');
            showLoginScreen();
        }
        ;
        document.getElementById('cancel-add-account-button').onclick = ()=>{
            const a = getAccounts();
            if (a.length > 0) switchAccount(getActiveAccountId() || a[0].id);
        }
        ;
        window.addEventListener('resize', handleResize);
        
        logger('Application loaded and initialized.', 'info');
    }
    );
</script>
    </body>
</html>
